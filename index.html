<!DOCTYPE html>
<html lang="lo">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lao Chat</title>
    <style>
      /* Enhanced Font Loading */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

      @font-face {
        font-family: 'Phetsarath OT';
        src: url('front/Phetsarath OT.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
        unicode-range: U+0E80-0EFF, U+200C-200D, U+25CC;
      }

      /* Fallback font for better Lao text rendering */
      @font-face {
        font-family: 'Phetsarath OT Fallback';
        src: local('Noto Sans Lao'), local('Lao Sangam MN'), local('DokChampa');
        font-display: swap;
        unicode-range: U+0E80-0EFF;
      }

      :root {
        /* Enhanced Color System */
        /* Primary Colors */
        --primary-50: #f0fdf4;
        --primary-100: #dcfce7;
        --primary-200: #bbf7d0;
        --primary-300: #86efac;
        --primary-400: #4ade80;
        --primary-500: #10a37f;
        --primary-600: #0d8a6b;
        --primary-700: #0a6b56;
        --primary-800: #065f46;
        --primary-900: #064e3b;
        --primary-950: #022c22;

        /* Neutral Colors */
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --gray-950: #030712;

        /* Semantic Colors */
        --success-50: #f0fdf4;
        --success-500: #22c55e;
        --success-600: #16a34a;
        --success-700: #15803d;

        --warning-50: #fffbeb;
        --warning-500: #f59e0b;
        --warning-600: #d97706;
        --warning-700: #b45309;

        --error-50: #fef2f2;
        --error-500: #ef4444;
        --error-600: #dc2626;
        --error-700: #b91c1c;

        --info-50: #eff6ff;
        --info-500: #3b82f6;
        --info-600: #2563eb;
        --info-700: #1d4ed8;

        /* Surface Colors */
        --surface-primary: #ffffff;
        --surface-secondary: #f8fafc;
        --surface-tertiary: #f1f5f9;
        --surface-elevated: #ffffff;
        --surface-overlay: rgba(0, 0, 0, 0.5);

        /* Legacy Variables (for backward compatibility) */
        --primary-color: var(--primary-500);
        --primary-hover: var(--primary-600);
        --secondary-color: var(--gray-50);
        --background-color: var(--surface-primary);
        --sidebar-bg: var(--gray-900);
        --sidebar-hover: var(--gray-800);
        --text-color: var(--gray-900);
        --text-secondary: var(--gray-500);
        --light-text-color: var(--gray-100);
        --border-color: var(--gray-200);
        --accent-color: var(--primary-500);
        --user-message-bg: var(--primary-500);
        --bot-message-bg: var(--gray-50);
        --success-color: var(--success-500);
        --warning-color: var(--warning-500);
        --error-color: var(--error-500);
        --info-color: var(--info-500);

        /* Enhanced Shadow System */
        --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        
        /* Legacy Shadow Variables */
        --shadow-light: var(--shadow-sm);
        --shadow-medium: var(--shadow-md);

        /* Enhanced Border Radius System */
        --radius-none: 0px;
        --radius-xs: 2px;
        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;
        --radius-xl: 12px;
        --radius-2xl: 16px;
        --radius-3xl: 24px;
        --radius-full: 9999px;

        /* Spacing System (8px base) */
        --space-0: 0px;
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 20px;
        --space-6: 24px;
        --space-7: 28px;
        --space-8: 32px;
        --space-10: 40px;
        --space-12: 48px;
        --space-16: 64px;
        --space-20: 80px;
        --space-24: 96px;

        /* Animation System */
        --duration-75: 75ms;
        --duration-100: 100ms;
        --duration-150: 150ms;
        --duration-200: 200ms;
        --duration-300: 300ms;
        --duration-500: 500ms;
        --duration-700: 700ms;
        --duration-1000: 1000ms;

        --ease-linear: linear;
        --ease-in: cubic-bezier(0.4, 0, 1, 1);
        --ease-out: cubic-bezier(0, 0, 0.2, 1);
        --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
        --ease-back: cubic-bezier(0.68, -0.55, 0.265, 1.55);

        /* Enhanced Typography System */
        --font-family-sans: "Phetsarath OT", "Phetsarath OT Fallback", "Inter", "Noto Sans Lao", "Lao Sangam MN", "DokChampa", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --font-family-mono: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", "Courier New", monospace;
        --font-family-display: "Inter", "Phetsarath OT", system-ui, sans-serif;

        --font-size-xs: 0.75rem;    /* 12px */
        --font-size-sm: 0.875rem;   /* 14px */
        --font-size-base: 1rem;     /* 16px */
        --font-size-lg: 1.125rem;   /* 18px */
        --font-size-xl: 1.25rem;    /* 20px */
        --font-size-2xl: 1.5rem;    /* 24px */
        --font-size-3xl: 1.875rem;  /* 30px */
        --font-size-4xl: 2.25rem;   /* 36px */

        --line-height-tight: 1.25;
        --line-height-snug: 1.375;
        --line-height-normal: 1.5;
        --line-height-relaxed: 1.625;
        --line-height-loose: 2;

        --font-weight-thin: 100;
        --font-weight-light: 300;
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        --font-weight-extrabold: 800;
        --font-weight-black: 900;
      }

      /* Enhanced Dark Theme */
      body.dark-theme {
        /* Dark Theme Color Overrides */
        --surface-primary: var(--gray-900);
        --surface-secondary: var(--gray-800);
        --surface-tertiary: var(--gray-700);
        --surface-elevated: var(--gray-800);

        /* Text Colors for Dark Theme */
        --text-color: var(--gray-100);
        --text-secondary: var(--gray-400);
        --light-text-color: var(--gray-100);

        /* Border Colors for Dark Theme */
        --border-color: var(--gray-700);

        /* Background Colors for Dark Theme */
        --background-color: var(--surface-primary);
        --sidebar-bg: var(--gray-950);
        --sidebar-hover: var(--gray-800);
        --bot-message-bg: var(--gray-800);

        /* Semantic Colors for Dark Theme */
        --success-color: var(--success-400);
        --warning-color: var(--warning-400);
        --error-color: var(--error-400);
        --info-color: var(--info-400);

        /* Legacy Variables for Dark Theme */
        --primary-color: var(--primary-400);
        --primary-hover: var(--primary-500);
        --secondary-color: var(--gray-800);
        --accent-color: var(--primary-400);
        --user-message-bg: var(--primary-600);

        /* Enhanced Shadows for Dark Theme */
        --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px -1px rgba(0, 0, 0, 0.4);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.4);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: var(--font-family-sans);
      }

      /* Enhanced Base Styles with Optimized Text Rendering */
      html {
        scroll-behavior: smooth;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        font-feature-settings: "kern" 1, "liga" 1, "calt" 1;
        font-variant-ligatures: common-ligatures;
      }

      body {
        font-family: var(--font-family-sans);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-normal);
        line-height: var(--line-height-normal);
        color: var(--text-color);
        background-color: var(--background-color);
        transition: background-color var(--duration-300) var(--ease-out),
                    color var(--duration-300) var(--ease-out);
        text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
      }

      /* Enhanced Smooth Scrolling and Micro-interactions */
      * {
        scroll-behavior: smooth;
      }

      /* Custom scrollbar animations */
      ::-webkit-scrollbar {
        transition: all var(--duration-200) var(--ease-out);
      }

      ::-webkit-scrollbar-thumb {
        transition: all var(--duration-200) var(--ease-out);
      }

      /* Enhanced focus styles for better accessibility */
      *:focus {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
        transition: outline var(--duration-200) var(--ease-out);
      }

      /* Enhanced focus states for interactive elements */
      button:focus, .btn:focus, [role="button"]:focus {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
        box-shadow: 0 0 0 4px rgba(16, 163, 127, 0.2);
        transform: translateY(-1px);
      }

      input:focus, textarea:focus {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
        box-shadow: 0 0 0 4px rgba(16, 163, 127, 0.1);
        border-color: var(--primary-400);
      }

      .chat-history-item:focus {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
        background: linear-gradient(135deg, var(--gray-700), var(--gray-800));
        transform: translateX(4px);
      }

      *:focus:not(:focus-visible) {
        outline: none;
      }

      /* Enhanced Interactive Elements */
      button, .btn, [role="button"] {
        cursor: pointer;
        transition: all var(--duration-200) var(--ease-out);
        position: relative;
        overflow: hidden;
      }

      button:hover, .btn:hover, [role="button"]:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        filter: brightness(1.05);
      }

      /* Enhanced micro-interactions for buttons */
      button, .btn, [role="button"] {
        position: relative;
        overflow: hidden;
      }

      button::before, .btn::before, [role="button"]::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width var(--duration-300) var(--ease-out), 
                    height var(--duration-300) var(--ease-out);
        pointer-events: none;
      }

      button:hover::before, .btn:hover::before, [role="button"]:hover::before {
        width: 120%;
        height: 120%;
      }

      button:active, .btn:active, [role="button"]:active {
        transform: translateY(0);
        transition: all var(--duration-100) var(--ease-out);
      }

      /* Enhanced ripple effect for buttons */
      .ripple-effect {
        position: relative;
        overflow: hidden;
      }

      .ripple-effect::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .ripple-effect:active::after {
        width: 300px;
        height: 300px;
      }

      /* Mobile-First Responsive Design */
      
      /* Base styles are mobile-first (320px+) */
      :root {
        --mobile-padding: var(--space-3);
        --mobile-gap: var(--space-2);
        --mobile-font-size: var(--font-size-sm);
        --mobile-line-height: var(--line-height-snug);
      }

      /* Enhanced Touch Targets for Mobile */
      button, .btn, [role="button"], 
      input, textarea, select,
      .chat-history-item,
      .message-action-btn {
        min-height: 44px; /* iOS recommended touch target */
        min-width: 44px;
      }

      /* Mobile-optimized spacing */
      .container {
        padding: 0;
        gap: 0;
      }

      .sidebar {
        width: 100%;
        position: fixed;
        top: 0;
        left: -100%;
        height: 100vh;
        z-index: 1000;
        transition: left var(--duration-300) var(--ease-out);
        border-right: none;
        box-shadow: var(--shadow-2xl);
      }

      .sidebar.show-sidebar {
        left: 0;
      }

      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all var(--duration-300) var(--ease-out);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }

      .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      /* Mobile chat container */
      .chat-container {
        padding: var(--mobile-padding);
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        height: calc(100vh - 140px); /* Account for header and input */
      }

      /* Mobile message styling */
      .message {
        max-width: 85%;
        margin-bottom: var(--space-4);
      }

      .message .text {
        padding: var(--space-3) var(--space-4);
        font-size: var(--mobile-font-size);
        line-height: var(--mobile-line-height);
      }

      .message .icon {
        width: 36px;
        height: 36px;
        font-size: 1.125rem;
      }

      /* Mobile input area */
      .chat-input-area {
        padding: var(--mobile-padding);
        background: var(--surface-primary);
        border-top: 1px solid var(--border-color);
        position: sticky;
        bottom: 0;
        z-index: 100;
        transition: all var(--duration-300) var(--ease-out);
      }

      /* Virtual keyboard support */
      body.keyboard-visible .chat-input-area {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        box-shadow: var(--shadow-xl);
        border-top: 2px solid var(--primary-500);
      }

      body.keyboard-visible .chat-container {
        padding-bottom: 80px;
        transition: all var(--duration-300) var(--ease-out);
      }

      /* Enhanced mobile input styling */
      #user-input {
        font-size: 16px; /* Prevent zoom on iOS */
        -webkit-appearance: none;
        appearance: none;
        border-radius: var(--radius-xl);
        border: 2px solid var(--border-color);
        background: var(--surface-primary);
        transition: all var(--duration-200) var(--ease-out);
        resize: none;
        overflow-y: auto;
        max-height: 120px;
      }

      #user-input:focus {
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        outline: none;
      }

      .chat-form {
        max-width: 100%;
        padding: var(--space-2);
        gap: var(--space-2);
      }

      #user-input {
        font-size: var(--font-size-base);
        padding: var(--space-3) var(--space-4);
        min-height: 44px;
      }

      .send-btn {
        width: 44px;
        height: 44px;
        padding: 0;
        flex-shrink: 0;
      }

      /* Tablet breakpoint (768px+) */
      @media (min-width: 768px) {
        :root {
          --mobile-padding: var(--space-4);
          --mobile-gap: var(--space-3);
          --mobile-font-size: var(--font-size-base);
        }

        .container {
          display: flex;
          padding: 0;
        }

        .sidebar {
          position: static;
          width: 280px;
          height: 100vh;
          left: 0;
          border-right: 1px solid var(--border-color);
          box-shadow: var(--shadow-xl);
        }

        .sidebar-overlay {
          display: none;
        }

        .chat-container {
          padding: var(--space-6);
          margin: var(--space-4);
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-sm);
          height: auto;
        }

        .message {
          max-width: 75%;
        }

        .message .text {
          padding: var(--space-4) var(--space-5);
          font-size: var(--font-size-base);
        }

        .message .icon {
          width: 44px;
          height: 44px;
          font-size: 1.5rem;
        }

        .chat-input-area {
          padding: var(--space-4) var(--space-6);
        }

        .chat-form {
          padding: var(--space-3);
          gap: var(--space-3);
        }
      }

      /* Desktop breakpoint (1024px+) */
      @media (min-width: 1024px) {
        .container {
          max-width: 1200px;
          margin: 0 auto;
          border-radius: var(--radius-xl);
          overflow: hidden;
          box-shadow: var(--shadow-2xl);
        }

        .sidebar {
          width: 320px;
        }

        .chat-container {
          padding: var(--space-8);
          margin: var(--space-6);
        }

        .message {
          max-width: 70%;
        }
      }

      /* Large desktop breakpoint (1440px+) */
      @media (min-width: 1440px) {
        .container {
          max-width: 1400px;
        }

        .sidebar {
          width: 360px;
        }
      }

      /* Mobile landscape orientation */
      @media (max-width: 768px) and (orientation: landscape) {
        .chat-header {
          padding: var(--space-2) var(--space-4);
        }

        .chat-header-title {
          font-size: var(--font-size-sm);
        }

        .sidebar {
          width: 60%;
          max-width: 280px;
        }

        .chat-container {
          height: calc(100vh - 100px);
        }

        .message .icon {
          width: 32px;
          height: 32px;
        }

        .message .text {
          padding: var(--space-2) var(--space-3);
        }
      }

      /* Safe area support for notched devices */
      @supports (padding: max(0px)) {
        .chat-header {
          padding-left: max(var(--space-4), env(safe-area-inset-left));
          padding-right: max(var(--space-4), env(safe-area-inset-right));
          padding-top: max(var(--space-3), env(safe-area-inset-top));
        }

        .chat-input-area {
          padding-left: max(var(--mobile-padding), env(safe-area-inset-left));
          padding-right: max(var(--mobile-padding), env(safe-area-inset-right));
          padding-bottom: max(var(--mobile-padding), env(safe-area-inset-bottom));
        }

        .sidebar {
          padding-left: max(var(--space-4), env(safe-area-inset-left));
        }
      }

      /* High DPI displays */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .message .icon {
          image-rendering: -webkit-optimize-contrast;
          image-rendering: crisp-edges;
        }
      }

      /* Dark mode mobile optimizations */
      @media (prefers-color-scheme: dark) and (max-width: 768px) {
        .chat-header {
          background: var(--gray-900);
          border-bottom-color: var(--gray-700);
        }

        .menu-btn:hover {
          background: var(--gray-800);
        }

        .header-btn:hover {
          background: var(--gray-800);
        }
      }

      /* Reduced motion preferences */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          scroll-behavior: auto !important;
        }
        font-synthesis: none;
      }

      /* Enhanced Touch Interactions */
      
      /* Touch-friendly scrollbars */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--gray-400);
        border-radius: var(--radius-full);
        border: 2px solid transparent;
        background-clip: content-box;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--gray-500);
        background-clip: content-box;
      }

      /* Enhanced touch targets */
      @media (pointer: coarse) {
        button, .btn, [role="button"],
        input, textarea, select,
        .chat-history-item,
        .message-action-btn {
          min-height: 48px;
          min-width: 48px;
          padding: var(--space-3);
        }

        .send-btn {
          width: 48px;
          height: 48px;
        }

        .new-chat-btn {
          padding: var(--space-4) var(--space-5);
          font-size: var(--font-size-base);
        }
      }

      /* Gesture support */
      .swipe-container {
        touch-action: pan-x pan-y;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      .chat-container {
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-y: contain;
        overscroll-behavior-x: none;
      }

      .sidebar {
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      /* Pull-to-refresh prevention */
      body {
        overscroll-behavior-y: contain;
        -webkit-overflow-scrolling: touch;
      }

      /* Enhanced tap highlighting */
      * {
        -webkit-tap-highlight-color: rgba(16, 163, 127, 0.2);
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      /* Allow text selection in content areas */
      .message .text,
      input, textarea,
      [contenteditable="true"] {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }

      /* Enhanced Text Selection */
      ::selection {
        background-color: rgba(16, 163, 127, 0.2);
        color: var(--text-color);
      }

      ::-moz-selection {
        background-color: rgba(16, 163, 127, 0.2);
        color: var(--text-color);
      }

      /* Enhanced Typography System with Optimized Rendering */
      .text-xs {
        font-size: var(--font-size-xs);
        line-height: var(--line-height-tight);
        letter-spacing: 0.025em;
      }
      .text-sm {
        font-size: var(--font-size-sm);
        line-height: var(--line-height-snug);
        letter-spacing: 0.01em;
      }
      .text-base {
        font-size: var(--font-size-base);
        line-height: var(--line-height-normal);
        letter-spacing: 0;
      }
      .text-lg {
        font-size: var(--font-size-lg);
        line-height: var(--line-height-normal);
        letter-spacing: -0.01em;
      }
      .text-xl {
        font-size: var(--font-size-xl);
        line-height: var(--line-height-normal);
        letter-spacing: -0.015em;
      }
      .text-2xl {
        font-size: var(--font-size-2xl);
        line-height: var(--line-height-tight);
        letter-spacing: -0.025em;
      }
      .text-3xl {
        font-size: var(--font-size-3xl);
        line-height: var(--line-height-tight);
        letter-spacing: -0.03em;
      }
      .text-4xl {
        font-size: var(--font-size-4xl);
        line-height: var(--line-height-tight);
        letter-spacing: -0.035em;
      }

      /* Display Typography for Headers */
      .text-display {
        font-family: var(--font-family-display);
        font-weight: var(--font-weight-bold);
        letter-spacing: -0.02em;
        text-rendering: optimizeLegibility;
      }

      /* Lao Text Optimization */
      .text-lao {
        font-family: "Phetsarath OT", "Phetsarath OT Fallback", "Noto Sans Lao", sans-serif;
        font-feature-settings: "kern" 1;
        text-rendering: optimizeLegibility;
        word-break: keep-all;
        overflow-wrap: break-word;
      }

      /* Monospace Text */
      .text-mono {
        font-family: var(--font-family-mono);
        font-variant-numeric: tabular-nums;
        letter-spacing: -0.01em;
      }

      /* Font Weight Utilities */
      .font-thin { font-weight: var(--font-weight-thin); }
      .font-light { font-weight: var(--font-weight-light); }
      .font-normal { font-weight: var(--font-weight-normal); }
      .font-medium { font-weight: var(--font-weight-medium); }
      .font-semibold { font-weight: var(--font-weight-semibold); }
      .font-bold { font-weight: var(--font-weight-bold); }
      .font-extrabold { font-weight: var(--font-weight-extrabold); }
      .font-black { font-weight: var(--font-weight-black); }

      /* Line Height Utilities */
      .leading-tight { line-height: var(--line-height-tight); }
      .leading-snug { line-height: var(--line-height-snug); }
      .leading-normal { line-height: var(--line-height-normal); }
      .leading-relaxed { line-height: var(--line-height-relaxed); }
      .leading-loose { line-height: var(--line-height-loose); }

      /* Enhanced Text Styling Utilities */
      .text-center { text-align: center; }
      .text-left { text-align: left; }
      .text-right { text-align: right; }
      .text-justify { text-align: justify; }

      .text-uppercase { text-transform: uppercase; }
      .text-lowercase { text-transform: lowercase; }
      .text-capitalize { text-transform: capitalize; }

      .text-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .text-ellipsis {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .text-break {
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
      }

      .text-nowrap { white-space: nowrap; }
      .text-pre { white-space: pre; }
      .text-pre-line { white-space: pre-line; }
      .text-pre-wrap { white-space: pre-wrap; }

      /* Letter Spacing Utilities */
      .tracking-tighter { letter-spacing: -0.05em; }
      .tracking-tight { letter-spacing: -0.025em; }
      .tracking-normal { letter-spacing: 0; }
      .tracking-wide { letter-spacing: 0.025em; }
      .tracking-wider { letter-spacing: 0.05em; }
      .tracking-widest { letter-spacing: 0.1em; }

      /* Text Color Utilities */
      .text-primary { color: var(--primary-500); }
      .text-secondary { color: var(--text-secondary); }
      .text-muted { color: var(--gray-400); }
      .text-success { color: var(--success-500); }
      .text-warning { color: var(--warning-500); }
      .text-error { color: var(--error-500); }
      .text-info { color: var(--info-500); }

      /* Text Decoration Utilities */
      .underline { text-decoration: underline; }
      .line-through { text-decoration: line-through; }
      .no-underline { text-decoration: none; }

      /* Enhanced Readability */
      .text-readable {
        max-width: 65ch;
        line-height: var(--line-height-relaxed);
      }

      .text-balance {
        text-wrap: balance;
      }

      /* Spacing Utilities */
      .m-0 { margin: var(--space-0); }
      .m-1 { margin: var(--space-1); }
      .m-2 { margin: var(--space-2); }
      .m-3 { margin: var(--space-3); }
      .m-4 { margin: var(--space-4); }
      .m-5 { margin: var(--space-5); }
      .m-6 { margin: var(--space-6); }
      .m-8 { margin: var(--space-8); }

      .mt-0 { margin-top: var(--space-0); }
      .mt-1 { margin-top: var(--space-1); }
      .mt-2 { margin-top: var(--space-2); }
      .mt-3 { margin-top: var(--space-3); }
      .mt-4 { margin-top: var(--space-4); }
      .mt-6 { margin-top: var(--space-6); }
      .mt-8 { margin-top: var(--space-8); }

      .mb-0 { margin-bottom: var(--space-0); }
      .mb-1 { margin-bottom: var(--space-1); }
      .mb-2 { margin-bottom: var(--space-2); }
      .mb-3 { margin-bottom: var(--space-3); }
      .mb-4 { margin-bottom: var(--space-4); }
      .mb-6 { margin-bottom: var(--space-6); }
      .mb-8 { margin-bottom: var(--space-8); }

      .ml-0 { margin-left: var(--space-0); }
      .ml-1 { margin-left: var(--space-1); }
      .ml-2 { margin-left: var(--space-2); }
      .ml-3 { margin-left: var(--space-3); }
      .ml-4 { margin-left: var(--space-4); }

      .mr-0 { margin-right: var(--space-0); }
      .mr-1 { margin-right: var(--space-1); }
      .mr-2 { margin-right: var(--space-2); }
      .mr-3 { margin-right: var(--space-3); }
      .mr-4 { margin-right: var(--space-4); }

      .p-0 { padding: var(--space-0); }
      .p-1 { padding: var(--space-1); }
      .p-2 { padding: var(--space-2); }
      .p-3 { padding: var(--space-3); }
      .p-4 { padding: var(--space-4); }
      .p-5 { padding: var(--space-5); }
      .p-6 { padding: var(--space-6); }
      .p-8 { padding: var(--space-8); }

      .px-0 { padding-left: var(--space-0); padding-right: var(--space-0); }
      .px-1 { padding-left: var(--space-1); padding-right: var(--space-1); }
      .px-2 { padding-left: var(--space-2); padding-right: var(--space-2); }
      .px-3 { padding-left: var(--space-3); padding-right: var(--space-3); }
      .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
      .px-6 { padding-left: var(--space-6); padding-right: var(--space-6); }

      .py-0 { padding-top: var(--space-0); padding-bottom: var(--space-0); }
      .py-1 { padding-top: var(--space-1); padding-bottom: var(--space-1); }
      .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
      .py-3 { padding-top: var(--space-3); padding-bottom: var(--space-3); }
      .py-4 { padding-top: var(--space-4); padding-bottom: var(--space-4); }
      .py-6 { padding-top: var(--space-6); padding-bottom: var(--space-6); }

      /* Border Radius Utilities */
      .rounded-none { border-radius: var(--radius-none); }
      .rounded-xs { border-radius: var(--radius-xs); }
      .rounded-sm { border-radius: var(--radius-sm); }
      .rounded-md { border-radius: var(--radius-md); }
      .rounded-lg { border-radius: var(--radius-lg); }
      .rounded-xl { border-radius: var(--radius-xl); }
      .rounded-2xl { border-radius: var(--radius-2xl); }
      .rounded-3xl { border-radius: var(--radius-3xl); }
      .rounded-full { border-radius: var(--radius-full); }

      /* Shadow Utilities */
      .shadow-none { box-shadow: none; }
      .shadow-xs { box-shadow: var(--shadow-xs); }
      .shadow-sm { box-shadow: var(--shadow-sm); }
      .shadow-md { box-shadow: var(--shadow-md); }
      .shadow-lg { box-shadow: var(--shadow-lg); }
      .shadow-xl { box-shadow: var(--shadow-xl); }
      .shadow-2xl { box-shadow: var(--shadow-2xl); }
      .shadow-inner { box-shadow: var(--shadow-inner); }

      /* Transition Utilities */
      .transition-none { transition: none; }
      .transition-all { 
        transition: all var(--duration-150) var(--ease-out); 
      }
      .transition-colors { 
        transition: color var(--duration-150) var(--ease-out),
                    background-color var(--duration-150) var(--ease-out),
                    border-color var(--duration-150) var(--ease-out); 
      }
      .transition-opacity { 
        transition: opacity var(--duration-150) var(--ease-out); 
      }
      .transition-transform { 
        transition: transform var(--duration-150) var(--ease-out); 
      }

      /* Animation Utilities */
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .animate-bounce {
        animation: bounce 1s infinite;
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      @keyframes bounce {
        0%, 100% {
          transform: translateY(-25%);
          animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }
        50% {
          transform: none;
          animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Main Layout Body Styles */
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: var(--background-color);
        transition: background-color var(--duration-300) var(--ease-out),
                    color var(--duration-300) var(--ease-out);
      }

      .container {
        display: flex;
        width: 100vw;
        height: 100vh;
        max-width: none;
        background-color: var(--background-color);
        border-radius: 0;
        overflow: hidden;
        box-shadow: none;
        position: relative;
      }

      /* Enhanced Sidebar */
      .sidebar {
        width: 280px;
        background: linear-gradient(180deg, var(--sidebar-bg) 0%, var(--gray-950) 100%);
        color: var(--light-text-color);
        padding: var(--space-5) var(--space-4);
        display: flex;
        flex-direction: column;
        transition: all var(--duration-300) var(--ease-out);
        border-right: 1px solid var(--border-color);
        box-shadow: var(--shadow-xl);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        position: relative;
        overflow: hidden;
      }

      .sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
        pointer-events: none;
      }

      .sidebar::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 1px;
        height: 100%;
        background: linear-gradient(180deg, transparent, var(--primary-500) 50%, transparent);
        opacity: 0.3;
      }

      .sidebar-header {
        position: relative;
        margin-bottom: var(--space-6);
        padding-bottom: var(--space-4);
      }

      .sidebar-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, var(--primary-500), transparent);
        opacity: 0.6;
      }

      .sidebar-header h2 {
        font-family: var(--font-family-display);
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-extrabold);
        color: var(--light-text-color);
        margin: 0;
        padding: var(--space-2) 0;
        text-align: left;
        background: linear-gradient(135deg, var(--primary-300), var(--primary-500), var(--primary-600));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.03em;
        text-rendering: optimizeLegibility;
        font-feature-settings: "kern" 1, "liga" 1;
        position: relative;
        animation: titleGlow 3s ease-in-out infinite alternate;
      }

      @keyframes titleGlow {
        0% {
          filter: drop-shadow(0 0 5px rgba(16, 163, 127, 0.3));
        }
        100% {
          filter: drop-shadow(0 0 15px rgba(16, 163, 127, 0.6));
        }
      }

      .new-chat-btn {
        width: 100%;
        padding: var(--space-4) var(--space-5);
        background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
        border: 1px solid var(--primary-500);
        color: white;
        border-radius: var(--radius-xl);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--space-6);
        transition: all var(--duration-300) var(--ease-out);
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
      }

      .new-chat-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left var(--duration-600) var(--ease-out);
      }

      .new-chat-btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent 50%);
        border-radius: inherit;
        pointer-events: none;
      }

      .new-chat-btn:hover {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        border-color: var(--primary-400);
        transform: translateY(-3px) scale(1.02);
        box-shadow: var(--shadow-xl);
      }

      .new-chat-btn:hover::before {
        left: 100%;
      }

      .new-chat-btn:active {
        transform: translateY(-1px) scale(0.98);
        box-shadow: var(--shadow-md);
        transition: all var(--duration-100) var(--ease-out);
      }

      .new-chat-btn .material-symbols-outlined {
        font-size: 1.25rem;
        transition: transform var(--duration-200) var(--ease-out);
      }

      .new-chat-btn:hover .material-symbols-outlined {
        transform: rotate(90deg);
      }

      .chat-history {
        flex-grow: 1;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--gray-600) transparent;
        padding-right: var(--space-2);
        margin-right: -var(--space-2);
        position: relative;
      }

      .chat-history::before {
        content: '';
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(180deg, var(--sidebar-bg), transparent);
        pointer-events: none;
        z-index: 1;
      }

      .chat-history::after {
        content: '';
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(0deg, var(--sidebar-bg), transparent);
        pointer-events: none;
        z-index: 1;
      }

      .chat-history::-webkit-scrollbar {
        width: 6px;
      }

      .chat-history::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-full);
      }

      .chat-history::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--gray-600), var(--gray-700));
        border-radius: var(--radius-full);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .chat-history::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, var(--gray-500), var(--gray-600));
      }

      .chat-history p {
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        color: var(--gray-400);
        margin: var(--space-4) 0 var(--space-2);
        padding: 0 var(--space-3);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .chat-history ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .chat-history li {
        padding: var(--space-3) var(--space-4);
        cursor: pointer;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        transition: all var(--duration-300) var(--ease-out);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: var(--space-2);
        position: relative;
        color: var(--gray-300);
        border: 1px solid transparent;
        backdrop-filter: blur(4px);
      }

      .chat-history li::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: transparent;
        border-radius: 0 var(--radius-md) var(--radius-md) 0;
        transition: all var(--duration-300) var(--ease-out);
      }

      .chat-history li::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent 50%);
        border-radius: inherit;
        opacity: 0;
        transition: opacity var(--duration-300) var(--ease-out);
        pointer-events: none;
      }

      .chat-history li:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--gray-100);
        transform: translateX(var(--space-2)) scale(1.02);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow-md);
      }

      .chat-history li:hover::before {
        background: linear-gradient(180deg, var(--primary-400), var(--primary-600));
        width: 6px;
      }

      .chat-history li:hover::after {
        opacity: 1;
      }

      .chat-history li.active {
        background: linear-gradient(135deg, rgba(16, 163, 127, 0.2), rgba(16, 163, 127, 0.1));
        color: var(--primary-200);
        border-color: rgba(16, 163, 127, 0.4);
        transform: translateX(var(--space-2));
        box-shadow: var(--shadow-lg);
      }

      .chat-history li.active::before {
        background: linear-gradient(180deg, var(--primary-300), var(--primary-500));
        width: 6px;
      }

      .chat-history li.active::after {
        opacity: 1;
      }

      /* Chat history item icon */
      .chat-history li .chat-icon {
        width: 24px;
        height: 24px;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, var(--gray-600), var(--gray-700));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--gray-300);
        flex-shrink: 0;
        transition: all var(--duration-200) var(--ease-out);
      }

      .chat-history li:hover .chat-icon {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        color: white;
        transform: scale(1.1);
      }

      .chat-history li.active .chat-icon {
        background: linear-gradient(135deg, var(--primary-400), var(--primary-500));
        color: white;
      }

      /* Enhanced chat history item layout */
      .chat-history-item {
        display: flex !important;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        animation: slideInFromLeft var(--duration-300) var(--ease-out) both;
        cursor: pointer;
        border-radius: var(--radius-lg);
        transition: all var(--duration-200) var(--ease-out);
        position: relative;
        overflow: hidden;
      }

      /* Enhanced hover effects for chat history items */
      .chat-history-item:hover {
        background: linear-gradient(135deg, var(--gray-700), var(--gray-800));
        transform: translateX(4px);
        box-shadow: var(--shadow-md);
      }

      .chat-history-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(135deg, var(--primary-400), var(--primary-600));
        transform: scaleY(0);
        transition: transform var(--duration-200) var(--ease-out);
      }

      .chat-history-item:hover::before {
        transform: scaleY(1);
      }

      .chat-history-item.active::before {
        transform: scaleY(1);
        background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
      }

      @keyframes slideInFromLeft {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .chat-title {
        flex: 1;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: inherit;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
      }

      .chat-metadata {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--space-1);
        flex-shrink: 0;
      }

      .message-count {
        background: linear-gradient(135deg, var(--gray-600), var(--gray-700));
        color: var(--gray-200);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-bold);
        padding: 2px var(--space-2);
        border-radius: var(--radius-full);
        min-width: 20px;
        text-align: center;
        line-height: 1.2;
        transition: all var(--duration-200) var(--ease-out);
      }

      .chat-history li:hover .message-count {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        color: white;
        transform: scale(1.1);
      }

      .chat-history li.active .message-count {
        background: linear-gradient(135deg, var(--primary-400), var(--primary-500));
        color: white;
      }

      .chat-time {
        font-size: 10px;
        color: var(--gray-500);
        font-weight: var(--font-weight-medium);
        opacity: 0.8;
        transition: opacity var(--duration-200) var(--ease-out);
      }

      .chat-history li:hover .chat-time {
        opacity: 1;
        color: var(--gray-300);
      }

      .chat-history li.active .chat-time {
        color: var(--primary-300);
        opacity: 1;
      }

      /* Chat list animation */
      .chat-list-animated {
        animation: fadeInUp var(--duration-400) var(--ease-out);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Empty state for chat history */
      .chat-history-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-8) var(--space-4);
        text-align: center;
        color: var(--gray-500);
      }

      .chat-history-empty .material-symbols-outlined {
        font-size: 3rem;
        margin-bottom: var(--space-4);
        opacity: 0.5;
      }

      .chat-history-empty p {
        font-size: var(--font-size-sm);
        margin: 0;
        opacity: 0.8;
      }

      .sidebar-section {
        margin-top: var(--space-6);
        padding-top: var(--space-5);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
      }

      .sidebar-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-500) 30%, var(--primary-600) 70%, transparent);
        opacity: 0.6;
      }

      .sidebar-section-title {
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-bold);
        color: var(--gray-300);
        margin-bottom: var(--space-4);
        padding: 0 var(--space-2);
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .sidebar-section-title::before {
        content: '';
        width: 8px;
        height: 8px;
        background: linear-gradient(135deg, var(--primary-400), var(--primary-600));
        border-radius: var(--radius-full);
        flex-shrink: 0;
      }

      .sidebar-footer {
        padding-top: var(--space-5);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: auto;
        position: relative;
      }

      .sidebar-footer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      }

      .sidebar-btn {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--light-text-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: var(--space-3);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        border-radius: var(--radius-lg);
        transition: all var(--duration-300) var(--ease-out);
        margin-bottom: var(--space-2);
        position: relative;
        overflow: hidden;
      }

      .sidebar-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left var(--duration-500) var(--ease-out);
      }

      .sidebar-btn:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px) translateX(var(--space-1));
        box-shadow: var(--shadow-lg);
        color: var(--primary-200);
      }

      .sidebar-btn:hover::before {
        left: 100%;
      }

      .sidebar-btn:active {
        transform: translateY(0) translateX(0);
        transition: all var(--duration-100) var(--ease-out);
      }

      .sidebar-btn .material-symbols-outlined {
        font-size: 1.125rem;
        transition: transform var(--duration-200) var(--ease-out);
      }

      .sidebar-btn:hover .material-symbols-outlined {
        transform: scale(1.1) rotate(5deg);
        transform: translateX(2px);
      }



      /* Chat Area */
      .chat-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
      }

      .chat-header {
        padding: 15px 25px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 500;
        min-height: 65px;
        background: var(--background-color);
        position: sticky;
        top: 0;
        z-index: 50;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header-btn {
        width: 40px;
        height: 40px;
        border: none;
        background: transparent;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.2s ease;
      }

      .header-btn:hover {
        background: var(--secondary-color);
        color: var(--text-color);
      }

      /* Enhanced Connection Status */
      .connection-status {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        transition: all var(--duration-300) var(--ease-out);
        backdrop-filter: blur(8px);
        border: 1px solid transparent;
      }

      .connection-status.online {
        background: linear-gradient(135deg, var(--success-50), rgba(34, 197, 94, 0.1));
        color: var(--success-600);
        border-color: var(--success-200);
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);
        animation: connectionSuccess var(--duration-500) var(--ease-out);
      }

      .connection-status.offline {
        background: linear-gradient(135deg, var(--error-50), rgba(239, 68, 68, 0.1));
        color: var(--error-600);
        border-color: var(--error-200);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
        animation: connectionError var(--duration-500) var(--ease-out);
      }

      .connection-status.connecting {
        background: linear-gradient(135deg, var(--warning-50), rgba(251, 146, 60, 0.1));
        color: var(--warning-600);
        border-color: var(--warning-200);
        box-shadow: 0 2px 8px rgba(251, 146, 60, 0.15);
        animation: connectionPulse 1.5s ease-in-out infinite;
      }

      /* Enhanced connection animations */
      @keyframes connectionSuccess {
        0% {
          transform: scale(0.9);
          opacity: 0.8;
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes connectionError {
        0% {
          transform: scale(0.9);
          opacity: 0.8;
        }
        25% {
          transform: scale(1.05) translateX(-2px);
        }
        75% {
          transform: scale(1.05) translateX(2px);
        }
        100% {
          transform: scale(1) translateX(0);
          opacity: 1;
        }
      }

      @keyframes connectionPulse {
        0%, 100% {
          opacity: 0.8;
          transform: scale(1);
        }
        50% {
          opacity: 1;
          transform: scale(1.02);
        }
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: var(--radius-full);
        transition: all var(--duration-300) var(--ease-out);
        position: relative;
      }

      .connection-status.online .status-dot {
        background: var(--success-500);
        animation: statusDotPulse 2s ease-in-out infinite;
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }

      .connection-status.offline .status-dot {
        background: var(--error-500);
        animation: statusDotError 1s ease-in-out infinite;
      }

      .connection-status.connecting .status-dot {
        background: var(--warning-500);
        animation: statusDotConnecting 1s ease-in-out infinite;
      }

      /* Status dot animations */
      @keyframes statusDotPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        70% {
          box-shadow: 0 0 0 6px rgba(34, 197, 94, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
      }

      @keyframes statusDotError {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }

      @keyframes statusDotConnecting {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      /* Success Feedback Animations System */
      .success-feedback {
        background: linear-gradient(135deg, var(--success-50), rgba(34, 197, 94, 0.05));
        border: 1px solid var(--success-200);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin: var(--space-2) 0;
        animation: successAppear var(--duration-500) var(--ease-out);
        position: relative;
        overflow: hidden;
      }

      .success-feedback::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
        animation: successShimmer 1s ease-out;
      }

      .success-feedback .success-icon {
        color: var(--success-500);
        font-size: 1.5rem;
        margin-bottom: var(--space-2);
        animation: successIconBounce var(--duration-600) var(--ease-out);
      }

      .success-feedback .success-title {
        color: var(--success-700);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--space-1);
      }

      .success-feedback .success-message {
        color: var(--success-600);
        font-size: var(--font-size-sm);
        line-height: var(--line-height-relaxed);
      }

      /* Toast notifications */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        color: white;
        font-weight: var(--font-weight-medium);
        z-index: 9999;
        animation: toastSlideIn var(--duration-400) var(--ease-out);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: var(--shadow-xl);
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: var(--space-3);
      }

      .toast.success {
        background: linear-gradient(135deg, var(--success-500), var(--success-600));
        border: 1px solid var(--success-400);
      }

      .toast.error {
        background: linear-gradient(135deg, var(--error-500), var(--error-600));
        border: 1px solid var(--error-400);
      }

      .toast.warning {
        background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
        border: 1px solid var(--warning-400);
      }

      .toast.info {
        background: linear-gradient(135deg, var(--info-500), var(--info-600));
        border: 1px solid var(--info-400);
      }

      .toast-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
      }

      .toast-content {
        flex: 1;
      }

      .toast-title {
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--space-1);
      }

      .toast-message {
        font-size: var(--font-size-sm);
        opacity: 0.9;
      }

      .toast-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: var(--space-1);
        border-radius: var(--radius-md);
        opacity: 0.7;
        transition: opacity var(--duration-200) var(--ease-out);
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* Progress indicators */
      .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--gray-200);
        border-radius: var(--radius-full);
        overflow: hidden;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
        border-radius: inherit;
        transition: width var(--duration-300) var(--ease-out);
        position: relative;
      }

      .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: progressShimmer 1.5s infinite;
      }

      /* Success animations */
      @keyframes successAppear {
        0% {
          opacity: 0;
          transform: translateY(-20px) scale(0.9);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes successShimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      @keyframes successIconBounce {
        0% {
          transform: scale(0);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes toastSlideIn {
        0% {
          opacity: 0;
          transform: translateX(100%);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes progressShimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      @keyframes statusPulse {
        0%, 100% { 
          opacity: 1; 
          transform: scale(1);
        }
        50% { 
          opacity: 0.6; 
          transform: scale(1.1);
        }
      }

      .user-icon-header {
        font-size: 2rem;
      }

      .chat-container {
        flex-grow: 1;
        padding: 25px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
        scroll-behavior: smooth;
        scroll-padding-top: var(--space-4);
        position: relative;
        transition: all var(--duration-300) var(--ease-out);
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      /* Scroll indicator for better UX */
      .chat-container::before {
        content: '';
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--primary-500), var(--primary-300));
        transform: scaleX(0);
        transform-origin: left;
        transition: transform var(--duration-200) var(--ease-out);
        z-index: 10;
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      }

      .chat-container.scrolled::before {
        transform: scaleX(1);
      }

      .chat-container::-webkit-scrollbar {
        width: 6px;
      }

      .chat-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-container::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
      }

      .chat-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      /* Enhanced Message Components */
      .message {
        display: flex;
        gap: var(--space-4);
        max-width: 85%;
        align-items: flex-start;
        margin-bottom: var(--space-5);
        animation: messageSlideIn var(--duration-300) var(--ease-out);
        position: relative;
        transition: all var(--duration-200) var(--ease-out);
      }

      @keyframes messageSlideIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Enhanced message appearance animation */
      @keyframes messageAppear {
        0% {
          opacity: 0;
          transform: translateY(30px) scale(0.9);
          filter: blur(4px);
        }
        60% {
          opacity: 0.8;
          transform: translateY(-2px) scale(1.02);
          filter: blur(0px);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0px);
        }
      }

      .message.new-message {
        animation: messageAppear var(--duration-400) var(--ease-out);
      }

      /* Enhanced state change animations */
      .message.editing {
        animation: messageEdit var(--duration-300) var(--ease-out);
      }

      .message.deleting {
        animation: messageDelete var(--duration-300) var(--ease-out) forwards;
      }

      .message.sending {
        animation: messageSending var(--duration-200) var(--ease-out) infinite alternate;
      }

      @keyframes messageEdit {
        0% {
          background-color: transparent;
        }
        50% {
          background-color: rgba(59, 130, 246, 0.1);
        }
        100% {
          background-color: transparent;
        }
      }

      @keyframes messageDelete {
        0% {
          opacity: 1;
          transform: scale(1) translateX(0);
        }
        50% {
          transform: scale(0.95) translateX(-10px);
        }
        100% {
          opacity: 0;
          transform: scale(0.8) translateX(-20px);
          height: 0;
          margin: 0;
          padding: 0;
        }
      }

      @keyframes messageSending {
        0% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
      }

      .message .icon {
        width: 44px;
        height: 44px;
        font-size: 1.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-shrink: 0;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
        border: 2px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
        transition: all var(--duration-200) var(--ease-out);
      }

      .message.user .icon {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        border-color: var(--primary-400);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .message.bot .icon {
        background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
        border-color: var(--gray-300);
        color: var(--gray-600);
      }

      .message {
        position: relative;
        transition: all var(--duration-200) var(--ease-out);
      }

      .message:hover {
        transform: translateY(-1px);
      }

      .message:hover .message-actions {
        opacity: 1;
        transform: translateY(0);
      }

      .message .text {
        padding: var(--space-4) var(--space-5);
        border-radius: var(--radius-2xl);
        line-height: var(--line-height-relaxed);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-normal);
        position: relative;
        box-shadow: var(--shadow-sm);
        transition: all var(--duration-200) var(--ease-out);
        backdrop-filter: blur(8px);
        text-rendering: optimizeLegibility;
        font-feature-settings: "kern" 1, "liga" 1;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        -webkit-hyphens: auto;
        -moz-hyphens: auto;
        min-height: 44px;
        display: flex;
        align-items: center;
      }

      /* Enhanced message text content */
      .message-text {
        width: 100%;
        line-height: 1.6;
      }

      .message-text strong {
        font-weight: var(--font-weight-semibold);
        color: inherit;
      }

      .message-text em {
        font-style: italic;
        opacity: 0.9;
      }

      /* Enhanced message bubble hover effects */
      .message:hover .text {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .message.user .text {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        color: white;
        border-bottom-right-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--primary-400);
        position: relative;
        overflow: hidden;
      }

      .message.user .text::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), transparent 50%);
        border-radius: inherit;
        pointer-events: none;
        transition: opacity var(--duration-200) var(--ease-out);
      }

      .message.user:hover .text::before {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), transparent 50%);
      }

      /* Enhanced user message shadow */
      .message.user:hover .text {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      .message.bot .text {
        background: var(--surface-secondary);
        color: var(--text-color);
        border-bottom-left-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
      }

      .message.bot .text::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.02), transparent 50%);
        border-radius: inherit;
        pointer-events: none;
        opacity: 0;
        transition: opacity var(--duration-200) var(--ease-out);
      }

      .message.bot:hover .text {
        background: var(--surface-primary);
        box-shadow: var(--shadow-md);
        border-color: var(--gray-300);
        transform: translateY(-1px);
      }

      .message.bot:hover .text::after {
        opacity: 1;
      }

      /* Enhanced Message Actions */
      .message-actions {
        position: absolute;
        top: -20px;
        right: var(--space-3);
        background: var(--surface-elevated);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-full);
        box-shadow: var(--shadow-lg);
        padding: var(--space-1);
        display: flex;
        gap: var(--space-1);
        opacity: 0;
        transform: translateY(12px) scale(0.9);
        transition: all var(--duration-300) var(--ease-back);
        z-index: 20;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      .message:hover .message-actions {
        opacity: 1;
        transform: translateY(0) scale(1);
        animation: actionsAppear var(--duration-300) var(--ease-back);
      }

      @keyframes actionsAppear {
        0% {
          opacity: 0;
          transform: translateY(12px) scale(0.8) rotate(-5deg);
        }
        60% {
          opacity: 0.8;
          transform: translateY(-2px) scale(1.05) rotate(1deg);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1) rotate(0deg);
        }
      }

      .message.user .message-actions {
        right: auto;
        left: var(--space-3);
        background: rgba(255, 255, 255, 0.95);
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      }

      .action-btn {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        border: none;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: var(--font-size-sm);
        color: var(--gray-500);
        transition: all var(--duration-200) var(--ease-out);
        position: relative;
        overflow: hidden;
      }

      .action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--gray-100);
        border-radius: inherit;
        opacity: 0;
        transform: scale(0.6);
        transition: all var(--duration-200) var(--ease-out);
      }

      .action-btn:hover::before {
        opacity: 1;
        transform: scale(1);
      }

      .action-btn:hover {
        color: var(--gray-700);
        transform: translateY(-2px) scale(1.1);
      }

      .action-btn:active {
        transform: translateY(0) scale(0.95);
        transition: all var(--duration-100) var(--ease-out);
      }

      .action-btn.active {
        background: var(--primary-500);
        color: white;
        box-shadow: var(--shadow-sm);
        transform: scale(1.05);
      }

      .action-btn.active::before {
        background: rgba(255, 255, 255, 0.2);
        opacity: 1;
        transform: scale(1);
      }

      /* Enhanced action button ripple effect */
      .action-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(0, 0, 0, 0.1);
        border-radius: var(--radius-full);
        transform: translate(-50%, -50%);
        transition: width var(--duration-300) var(--ease-out), 
                    height var(--duration-300) var(--ease-out);
      }

      .action-btn:active::after {
        width: 40px;
        height: 40px;
      }

      /* Action Button Tooltips */
      .action-btn[data-tooltip] {
        position: relative;
      }

      .action-btn[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: -32px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--gray-900);
        color: white;
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-xs);
        white-space: nowrap;
        z-index: 30;
        animation: tooltipFadeIn var(--duration-200) var(--ease-out);
      }

      @keyframes tooltipFadeIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }

      /* Enhanced Message Meta */
      .message-meta {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-top: var(--space-2);
        font-size: var(--font-size-xs);
        color: var(--gray-500);
        font-weight: var(--font-weight-medium);
        opacity: 0;
        transform: translateY(6px);
        transition: all var(--duration-300) var(--ease-out);
        padding: 0 var(--space-1);
      }

      .message:hover .message-meta {
        opacity: 1;
        transform: translateY(0);
      }

      .message.user .message-meta {
        justify-content: flex-end;
        color: rgba(255, 255, 255, 0.8);
      }

      .message-timestamp {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-3);
        background: var(--gray-100);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        transition: all var(--duration-200) var(--ease-out);
        border: 1px solid var(--gray-200);
        backdrop-filter: blur(4px);
      }

      .message-timestamp:hover {
        background: var(--gray-200);
        transform: translateY(-1px);
        box-shadow: var(--shadow-xs);
      }

      .message.user .message-timestamp {
        background: rgba(255, 255, 255, 0.25);
        color: rgba(255, 255, 255, 0.95);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .message.user .message-timestamp:hover {
        background: rgba(255, 255, 255, 0.35);
      }

      .message-status {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        transition: all var(--duration-200) var(--ease-out);
        border: 1px solid transparent;
        position: relative;
        overflow: hidden;
      }

      .message-status::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left var(--duration-500) var(--ease-out);
      }

      .message-status:hover::before {
        left: 100%;
      }

      .message-status.sent {
        background: var(--success-50);
        color: var(--success-600);
        border-color: var(--success-200);
      }

      .message-status.sent:hover {
        background: var(--success-100);
        transform: translateY(-1px);
        box-shadow: var(--shadow-xs);
      }

      .message-status.delivered {
        background: var(--info-50);
        color: var(--info-600);
        border-color: var(--info-200);
      }

      .message-status.delivered:hover {
        background: var(--info-100);
        transform: translateY(-1px);
        box-shadow: var(--shadow-xs);
      }

      .message-status.read {
        background: var(--primary-50);
        color: var(--primary-600);
        border-color: var(--primary-200);
      }

      .message-status.read:hover {
        background: var(--primary-100);
        transform: translateY(-1px);
        box-shadow: var(--shadow-xs);
      }

      /* Status indicator icons */
      .message-status .status-icon {
        width: 12px;
        height: 12px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
      }

      .message-status.sent .status-icon {
        background: var(--success-500);
        color: white;
      }

      .message-status.delivered .status-icon {
        background: var(--info-500);
        color: white;
      }

      .message-status.read .status-icon {
        background: var(--primary-500);
        color: white;
      }

      /* Enhanced Message Reactions */
      .message-reactions {
        display: flex;
        gap: var(--space-1);
        margin-top: var(--space-2);
        flex-wrap: wrap;
        opacity: 0;
        transform: translateY(4px);
        transition: all var(--duration-200) var(--ease-out);
      }

      .message:hover .message-reactions {
        opacity: 1;
        transform: translateY(0);
      }

      .reaction-btn {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-2);
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        cursor: pointer;
        transition: all var(--duration-200) var(--ease-out);
        position: relative;
        overflow: hidden;
      }

      .reaction-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        transition: left var(--duration-300) var(--ease-out);
      }

      .reaction-btn:hover::before {
        left: 100%;
      }

      .reaction-btn:hover {
        background: var(--gray-200);
        transform: translateY(-1px) scale(1.05);
        box-shadow: var(--shadow-xs);
      }

      .reaction-btn.active {
        background: var(--primary-100);
        border-color: var(--primary-300);
        color: var(--primary-600);
      }

      .reaction-emoji {
        font-size: 14px;
        line-height: 1;
      }

      .reaction-count {
        font-weight: var(--font-weight-medium);
        min-width: 16px;
        text-align: center;
      }

      /* Message loading state */
      .message.loading .text {
        background: var(--gray-100);
        color: var(--gray-400);
        position: relative;
        overflow: hidden;
      }

      .message.loading .text::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      /* Message error state */
      .message.error .text {
        background: var(--error-50);
        border-color: var(--error-200);
        color: var(--error-700);
      }

      .message.error .icon {
        background: linear-gradient(135deg, var(--error-500), var(--error-600));
        border-color: var(--error-400);
        color: white;
      }

      .reaction {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .reaction:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .reaction.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      /* Threaded Replies */
      .thread-container {
        margin-left: 60px;
        margin-top: 12px;
        border-left: 2px solid var(--border-color);
        padding-left: 16px;
        position: relative;
      }

      .thread-toggle {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 6px 12px;
        font-size: 0.8rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 12px;
        transition: all 0.2s ease;
        color: var(--text-secondary);
      }

      .thread-toggle:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .thread-toggle.expanded {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .thread-messages {
        display: none;
        gap: 12px;
        flex-direction: column;
      }

      .thread-messages.expanded {
        display: flex;
      }

      .thread-message {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 12px;
        font-size: 0.9rem;
        position: relative;
      }

      .thread-message.user {
        background: rgba(16, 163, 127, 0.1);
        border-color: var(--primary-color);
        margin-left: 20px;
      }

      .thread-message.bot {
        background: var(--bot-message-bg);
        margin-right: 20px;
      }

      .thread-input {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      .thread-input input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        background: var(--background-color);
        color: var(--text-color);
      }

      .thread-input button {
        padding: 8px 12px;
        background: var(--primary-color);
        border: none;
        border-radius: var(--radius-sm);
        color: white;
        cursor: pointer;
        font-size: 0.8rem;
      }

      /* Voice Input */
      .voice-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Enhanced Action Buttons */
      .input-actions {
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .action-btn, .voice-btn {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-full);
        border: 1px solid var(--gray-300);
        background: linear-gradient(135deg, var(--surface-primary), var(--gray-50));
        color: var(--gray-600);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all var(--duration-300) var(--ease-out);
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
      }

      .action-btn::before, .voice-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        transition: left var(--duration-400) var(--ease-out);
      }

      .action-btn:hover, .voice-btn:hover {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        color: white;
        transform: translateY(-2px) scale(1.05);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-400);
      }

      .action-btn:hover::before, .voice-btn:hover::before {
        left: 100%;
      }

      .action-btn:active, .voice-btn:active {
        transform: translateY(0) scale(1);
        transition: all var(--duration-100) var(--ease-out);
      }

      /* Voice Button States */
      .voice-btn.recording {
        background: linear-gradient(135deg, var(--error-500), var(--error-600));
        color: white;
        border-color: var(--error-400);
        animation: recordingPulse 1.5s ease-in-out infinite;
      }

      .voice-btn.processing {
        background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
        color: white;
        border-color: var(--warning-400);
        animation: processingRotate 1s linear infinite;
      }

      @keyframes recordingPulse {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        50% { 
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
      }

      @keyframes processingRotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      /* File Upload Button */
      .file-btn {
        position: relative;
      }

      .file-btn input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      /* Emoji Button */
      .emoji-btn:hover {
        background: linear-gradient(135deg, var(--warning-400), var(--warning-500)) !important;
      }

      /* Templates Button */
      .templates-btn:hover {
        background: linear-gradient(135deg, var(--info-500), var(--info-600)) !important;
      }

      /* File Upload */
      .file-upload {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-upload input[type=file] {
        position: absolute;
        left: -9999px;
      }

      .file-preview {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .file-item {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 8px 12px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 8px;
        max-width: 200px;
      }

      .file-item .remove-file {
        cursor: pointer;
        color: var(--error-color);
        font-weight: bold;
      }

      /* Message Templates */
      .templates-panel {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-medium);
        padding: 16px;
        margin-bottom: 8px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.2s ease;
        z-index: 100;
        max-height: 300px;
        overflow-y: auto;
      }

      .templates-panel.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .template-item {
        padding: 12px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid var(--border-color);
      }

      .template-item:last-child {
        border-bottom: none;
      }

      .template-item:hover {
        background: var(--secondary-color);
      }

      .template-title {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
      }

      .template-preview {
        font-size: 0.85rem;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .copy-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.875rem;
        opacity: 0;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 6px 8px;
        backdrop-filter: blur(4px);
      }

      .message.bot:hover .copy-btn {
        opacity: 1;
      }

      .copy-btn:hover {
        color: var(--text-color);
        background: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-light);
      }

      .message-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 10px;
      }

      .message-actions button {
        background: none;
        border: none;
        cursor: pointer;
        color: #888;
      }

      /* Enhanced Chat Input Area */
      .chat-input-area {
        padding: var(--space-6) var(--space-6) var(--space-5);
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        background: linear-gradient(180deg, var(--surface-primary), var(--surface-secondary));
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        position: relative;
        transition: all var(--duration-300) var(--ease-out);
      }

      .chat-input-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-500) 30%, var(--primary-600) 70%, transparent);
        opacity: 0.6;
      }

      .chat-input-area::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent 50%);
        pointer-events: none;
      }

      .suggestions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .suggestions button {
        padding: 8px 15px;
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .suggestions button:hover {
        background-color: #f0f0f0;
      }

      .regenerate-btn {
        margin-bottom: 15px;
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        color: #555;
      }

      /* Enhanced Chat Form */
      .chat-form {
        display: flex;
        align-items: flex-end;
        width: 100%;
        max-width: 800px;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-3xl);
        padding: var(--space-2);
        background: linear-gradient(135deg, var(--surface-primary), var(--surface-secondary));
        transition: all var(--duration-300) var(--ease-out);
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        position: relative;
        overflow: hidden;
        gap: var(--space-2);
      }

      .chat-form::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), transparent 50%);
        pointer-events: none;
        border-radius: inherit;
      }

      .chat-form::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, transparent, rgba(16, 163, 127, 0.05) 50%, transparent);
        opacity: 0;
        transition: opacity var(--duration-300) var(--ease-out);
        pointer-events: none;
        border-radius: inherit;
      }

      .chat-form:focus-within {
        border-color: var(--primary-500);
        box-shadow: 0 0 0 4px rgba(16, 163, 127, 0.15), var(--shadow-xl);
        transform: translateY(-2px);
      }

      .chat-form:focus-within::after {
        opacity: 1;
      }

      /* Enhanced Input Field */
      .input-container {
        flex-grow: 1;
        position: relative;
        display: flex;
        align-items: center;
      }

      #user-input {
        width: 100%;
        border: none;
        padding: var(--space-4) var(--space-5);
        font-size: var(--font-size-base);
        font-family: var(--font-family-sans);
        font-weight: var(--font-weight-normal);
        outline: none;
        background: rgba(255, 255, 255, 0.8);
        border-radius: var(--radius-2xl);
        resize: none;
        min-height: 48px;
        max-height: 150px;
        line-height: var(--line-height-relaxed);
        color: var(--text-color);
        transition: all var(--duration-300) var(--ease-out);
        text-rendering: optimizeLegibility;
        font-feature-settings: "kern" 1, "liga" 1;
        word-wrap: break-word;
        overflow-wrap: break-word;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--gray-300) transparent;
        border: 1px solid var(--gray-200);
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      #user-input::-webkit-scrollbar {
        width: 4px;
      }

      #user-input::-webkit-scrollbar-track {
        background: transparent;
      }

      #user-input::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: var(--radius-full);
      }

      #user-input::-webkit-scrollbar-thumb:hover {
        background: var(--gray-400);
      }

      #user-input:focus {
        background: rgba(255, 255, 255, 0.95);
        border-color: var(--primary-400);
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 
                    0 0 0 3px rgba(16, 163, 127, 0.1);
        transform: translateY(-1px);
      }

      #user-input::placeholder {
        color: var(--gray-500);
        font-weight: var(--font-weight-normal);
        font-style: normal;
        opacity: 0.8;
        transition: all var(--duration-200) var(--ease-out);
      }

      #user-input:focus::placeholder {
        opacity: 0.5;
        transform: translateY(-1px);
      }

      /* Character counter */
      .char-counter {
        position: absolute;
        bottom: var(--space-1);
        right: var(--space-3);
        font-size: var(--font-size-xs);
        color: var(--gray-400);
        font-weight: var(--font-weight-medium);
        opacity: 0;
        transition: opacity var(--duration-200) var(--ease-out);
        pointer-events: none;
      }

      #user-input:focus + .char-counter {
        opacity: 1;
      }

      .char-counter.warning {
        color: var(--warning-500);
      }

      .char-counter.error {
        color: var(--error-500);
      }

      /* Enhanced Send Button */
      .send-btn {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        border: none;
        cursor: pointer;
        padding: var(--space-3);
        color: white;
        border-radius: var(--radius-full);
        width: 52px;
        height: 52px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all var(--duration-300) var(--ease-out);
        flex-shrink: 0;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
        border: 2px solid var(--primary-400);
      }

      .send-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left var(--duration-400) var(--ease-out);
      }

      .send-btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent 50%);
        border-radius: inherit;
        pointer-events: none;
      }

      .send-btn:hover {
        background: linear-gradient(135deg, var(--primary-400), var(--primary-500));
        transform: translateY(-3px) scale(1.08);
        box-shadow: var(--shadow-xl);
        border-color: var(--primary-300);
        filter: brightness(1.1) saturate(1.1);
      }

      .send-btn:hover::before {
        left: 100%;
      }

      .send-btn:active {
        transform: translateY(-1px) scale(1.02);
        box-shadow: var(--shadow-lg);
        transition: all var(--duration-100) var(--ease-out);
      }

      .send-btn:disabled {
        background: linear-gradient(135deg, var(--gray-300), var(--gray-400));
        cursor: not-allowed;
        transform: none;
        box-shadow: var(--shadow-sm);
        border-color: var(--gray-300);
        opacity: 0.6;
      }

      .send-btn:disabled::before {
        display: none;
      }

      .send-btn .material-symbols-outlined {
        font-size: 1.25rem;
        transition: transform var(--duration-200) var(--ease-out);
      }

      .send-btn:hover .material-symbols-outlined {
        transform: translateX(2px);
      }

      /* Loading state for send button */
      .send-btn.loading {
        background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
        cursor: wait;
        animation: pulse 1.5s ease-in-out infinite;
      }

      .send-btn.loading .material-symbols-outlined {
        animation: spin 1s linear infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .menu-btn {
        display: none; /* Ẩน nút menu trên màn hình lớn */
        background: none;
        border: none;
        color: var(--text-color);
        cursor: pointer;
        font-size: 1.5rem;
      }

      @media (max-width: 768px) {
        .container {
          width: 100vw;
          height: 100vh;
          border-radius: 0;
          position: fixed;
          top: 0;
          left: 0;
          display: grid;
          grid-template-rows: auto 1fr auto;
          grid-template-areas: 
            "header"
            "content" 
            "input";
        }

        .sidebar {
          position: fixed;
          left: -280px;
          top: 0;
          height: 100%;
          z-index: 1001;
          transition: all var(--duration-400) var(--ease-out);
          box-shadow: var(--shadow-medium);
          transform: translateX(-20px) scale(0.95);
        }

        .sidebar.show-sidebar {
          left: 0;
          transform: translateX(0) scale(1);
          box-shadow: 0 0 60px rgba(0,0,0,0.6);
        }

        .sidebar-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.6);
          z-index: 1000;
          backdrop-filter: blur(4px);
          -webkit-backdrop-filter: blur(4px);
          transition: all var(--duration-300) var(--ease-out);
          opacity: 0;
        }

        .sidebar-overlay.active {
          display: block;
          opacity: 1;
        }

        .chat-area {
          width: 100%;
          height: 100vh;
          display: grid;
          grid-template-rows: auto 1fr auto;
          grid-template-areas: 
            "header"
            "content" 
            "input";
        }

        .menu-btn {
          display: flex;
        }

        /* Mobile-specific optimizations */
        .chat-header-title {
          font-size: var(--font-size-base);
        }

        .header-controls {
          gap: var(--space-1);
        }

        .header-btn {
          min-width: 36px;
          min-height: 36px;
          padding: var(--space-1);
        }

        .connection-status .status-text {
          display: none; /* Hide text on small screens */
        }

        /* Enhanced mobile message styling */
        .message .text {
          font-size: var(--font-size-sm);
          line-height: var(--line-height-relaxed);
          word-break: break-word;
          overflow-wrap: break-word;
        }

        /* Mobile input enhancements */
        .chat-form {
          padding: var(--space-2);
          gap: var(--space-2);
        }

        #user-input {
          font-size: 16px; /* Prevent zoom on iOS */
          padding: var(--space-3);
          border-radius: var(--radius-xl);
        }

        .send-btn {
          width: 40px;
          height: 40px;
          border-radius: var(--radius-full);
        }

        /* Mobile sidebar enhancements */
        .sidebar {
          width: 85%;
          max-width: 320px;
        }

        .new-chat-btn {
          font-size: var(--font-size-sm);
          padding: var(--space-3) var(--space-4);
        }

        .chat-history-item {
          padding: var(--space-3);
          gap: var(--space-3);
        }

        .chat-title {
          font-size: var(--font-size-sm);
        }

        .chat-header {
          grid-area: header;
          gap: 10px;
          padding: 10px 15px;
          min-height: 60px;
          flex-shrink: 0;
        }
        
        .header-btn {
            width: 36px;
            height: 36px;
        }

        .chat-container {
          grid-area: content;
          padding: 12px;
          gap: 15px;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          min-height: 0; /* Important for grid */
        }

        .chat-input-area {
          grid-area: input;
          padding: var(--space-4) var(--space-4) var(--space-3);
        }

        .chat-form {
          max-width: 100%;
          padding: var(--space-1);
          gap: var(--space-1);
        }

        .input-actions {
          gap: var(--space-1);
        }

        .action-btn, .voice-btn {
          width: 40px;
          height: 40px;
        }

        .send-btn {
          width: 44px;
          height: 44px;
        }

        #user-input {
          padding: var(--space-3) var(--space-4);
          font-size: var(--font-size-base);
          min-height: 44px;
          max-height: 120px;
        }

        .char-counter {
          bottom: var(--space-1);
          right: var(--space-2);
          font-size: 10px;
          background: #fff;
          border-top: 1px solid var(--border-color);
          z-index: 100;
          box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .welcome-screen {
          padding: 20px;
          height: auto;
          min-height: auto;
        }

        .welcome-title {
          font-size: var(--font-size-2xl);
          letter-spacing: -0.015em;
        }

        .welcome-subtitle {
          font-size: var(--font-size-base);
          line-height: var(--line-height-normal);
        }

        .suggestion-cards {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        .message {
          max-width: 90%;
          word-wrap: break-word;
          margin-bottom: var(--space-4);
        }

        .message .text {
          padding: var(--space-3) var(--space-4);
          font-size: var(--font-size-sm);
        }

        .message .icon {
          width: 36px;
          height: 36px;
          font-size: 1.25rem;
        }

        .message-actions {
          top: -16px;
          padding: var(--space-1);
          gap: var(--space-1);
        }

        .action-btn {
          width: 32px;
          height: 32px;
          font-size: var(--font-size-xs);
        }

        .message-meta {
          margin-top: var(--space-1);
          gap: var(--space-1);
        }

        .message-timestamp {
          padding: var(--space-1) var(--space-2);
          font-size: 10px;
        }

        .message-status {
          padding: var(--space-1) var(--space-2);
          font-size: 10px;
          overflow-wrap: break-word;
        }

        .message .icon {
            width: 32px;
            height: 32px;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .message .text {
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-size-sm);
            line-height: var(--line-height-normal);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            text-rendering: optimizeLegibility;
        }

        .message-text {
          word-wrap: break-word;
          overflow-wrap: break-word;
          white-space: pre-wrap;
          line-height: var(--line-height-normal);
        }

        /* Mobile Input Typography */
        #user-input {
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            padding: var(--space-3) var(--space-3);
        }

        .chat-form {
            padding: 2px;
            max-width: 100%;
        }

        #user-input {
            padding: 10px 12px;
            font-size: 0.95rem;
            max-height: 100px;
        }

        .chat-form button {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        .modal-content {
            width: 95%;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Đảm bảo body không scroll trên mobile */
        body {
          overflow: hidden;
          position: fixed;
          width: 100%;
          height: 100%;
        }

        /* Đảm bảo grid layout hoạt động đúng */
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
        }

        /* Fix cho typing indicator */
        .typing-indicator {
          margin-bottom: 10px;
        }

        /* Cải thiện scroll behavior */
        .chat-container::-webkit-scrollbar {
          width: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb {
          background: rgba(0,0,0,0.3);
          border-radius: 3px;
        }
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #fefefe;
        padding: 30px;
        border: none;
        width: 90%;
        max-width: 450px;
        text-align: center;
        border-radius: 15px;
        position: relative;
        animation: fadeIn 0.3s;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .close-btn {
        color: #aaa;
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
      }

      .close-btn:hover {
        color: #333;
      }

      .modal-qr-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .modal-qr-container img {
        width: 48%;
        height: auto;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .modal-content p {
        font-size: 1.1rem;
        color: var(--text-color);
      }

      .about-me-modal-content {
        text-align: left;
      }

      .about-me-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
      }

      .about-me-header img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary-color);
        margin-top: 15px;
      }

      .about-me-header h3 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .about-me-body p {
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .about-me-body a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
      }

      .about-me-body a:hover {
        text-decoration: underline;
      }

      /* Welcome Screen */
      .welcome-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 40px;
        max-width: 600px;
        margin: 0 auto;
      }

      .welcome-icon {
        font-size: 4rem;
        color: var(--primary-color);
        margin-bottom: 24px;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .welcome-title {
        font-family: var(--font-family-display);
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        color: var(--text-color);
        margin-bottom: var(--space-3);
        letter-spacing: -0.02em;
        text-rendering: optimizeLegibility;
        font-feature-settings: "kern" 1, "liga" 1;
        background: linear-gradient(135deg, var(--text-color), var(--gray-600));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .welcome-subtitle {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-normal);
        color: var(--text-secondary);
        margin-bottom: var(--space-8);
        line-height: var(--line-height-relaxed);
        max-width: 60ch;
        margin-left: auto;
        margin-right: auto;
        text-rendering: optimizeLegibility;
      }

      .suggestion-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        width: 100%;
        max-width: 500px;
        margin-bottom: 32px;
      }

      .suggestion-card {
        background: var(--bot-message-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: left;
      }

      .suggestion-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .suggestion-card h4 {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 8px;
      }

      .suggestion-card p {
        font-size: 0.8rem;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      /* Enhanced Typing Indicator */
      .typing-indicator {
        animation: typingIndicatorAppear var(--duration-300) var(--ease-out);
      }

      @keyframes typingIndicatorAppear {
        from {
          opacity: 0;
          transform: translateY(10px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .typing-dots {
        display: inline-flex;
        gap: var(--space-1);
        padding: var(--space-3) 0;
        align-items: center;
      }

      .typing-dot {
        width: 10px;
        height: 10px;
        background: linear-gradient(135deg, var(--primary-400), var(--primary-600));
        border-radius: var(--radius-full);
        animation: typingBounce 1.4s infinite ease-in-out;
        box-shadow: 0 2px 4px rgba(16, 163, 127, 0.3);
      }

      .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      
      .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
      }
      
      .typing-dot:nth-child(3) {
        animation-delay: 0s;
      }

      @keyframes typingBounce {
        0%, 80%, 100% {
          transform: scale(0.8) translateY(0);
          opacity: 0.6;
        }
        40% {
          transform: scale(1.2) translateY(-8px);
          opacity: 1;
        }
      }

      /* Enhanced typing indicator text container */
      .typing-indicator .text {
        background: linear-gradient(135deg, var(--surface-secondary), var(--gray-100));
        border: 1px solid var(--gray-200);
        position: relative;
        overflow: hidden;
      }

      .typing-indicator .text::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(16, 163, 127, 0.1), transparent);
        animation: typingShimmer 2s infinite;
      }

      @keyframes typingShimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      /* Ripple effect animation */
      @keyframes ripple {
        0% {
          transform: scale(0);
          opacity: 1;
        }
        100% {
          transform: scale(2);
          opacity: 0;
        }
      }

      /* Enhanced Mobile Header and Navigation */
      .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-3) var(--space-4);
        background: var(--surface-primary);
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: var(--shadow-sm);
      }

      .chat-header-title {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--text-color);
        margin: 0;
        flex: 1;
        text-align: center;
      }

      .chat-header-actions {
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      /* Mobile header controls */
      .header-controls {
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .header-btn {
        padding: var(--space-2);
        border-radius: var(--radius-md);
        background: none;
        border: none;
        color: var(--text-color);
        cursor: pointer;
        transition: all var(--duration-200) var(--ease-out);
        min-width: 40px;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .header-btn:hover {
        background: var(--gray-100);
        transform: scale(1.05);
      }

      .header-btn:active {
        transform: scale(0.95);
        background: var(--gray-200);
      }

      /* Connection status mobile styling */
      .connection-status {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-full);
        background: var(--success-50);
        border: 1px solid var(--success-200);
        font-size: var(--font-size-xs);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        background: var(--success-500);
        animation: pulse 2s infinite;
      }

      .status-text {
        color: var(--success-700);
        font-weight: var(--font-weight-medium);
      }

      /* Enhanced menu button */
      .menu-btn {
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        transition: all var(--duration-200) var(--ease-out);
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .menu-btn:hover {
        background: var(--gray-100);
        transform: scale(1.05);
      }

      .menu-btn:active {
        transform: scale(0.95);
        background: var(--gray-200);
      }

      /* Search Modal */
      .search-modal-content {
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        padding: 0;
        overflow: hidden;
      }

      .search-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
      }

      .search-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
      }

      .search-input-container {
        display: flex;
        padding: 20px 24px;
        gap: 12px;
      }

      #search-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 1rem;
        background: var(--background-color);
        color: var(--text-color);
        transition: border-color 0.2s ease;
      }

      #search-input:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      #search-submit {
        padding: 12px;
        background: var(--primary-color);
        border: none;
        border-radius: var(--radius-md);
        color: white;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      #search-submit:hover {
        background: var(--primary-hover);
      }

      .search-filters {
        display: flex;
        gap: 8px;
        padding: 0 24px 20px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        background: transparent;
        border-radius: 20px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-secondary);
      }

      .filter-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
      }

      .filter-btn:hover:not(.active) {
        background: var(--secondary-color);
        color: var(--text-color);
      }

      .search-results {
        max-height: 400px;
        overflow-y: auto;
        padding: 0 24px 24px;
      }

      .search-placeholder {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
      }

      .search-placeholder .material-symbols-outlined {
        font-size: 3rem;
        margin-bottom: 12px;
        opacity: 0.5;
      }

      .search-result-item {
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .search-result-item:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-light);
      }

      .search-result-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .search-result-text {
        color: var(--text-color);
        line-height: 1.5;
      }

      .search-highlight {
        background: yellow;
        color: black;
        padding: 2px 4px;
        border-radius: 3px;
      }

      /* Share Modal */
      .share-modal-content {
        max-width: 500px;
        width: 90%;
        padding: 0;
      }

      .share-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
      }

      .share-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
      }

      .share-options {
        padding: 24px;
      }

      .share-option {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        margin-bottom: 16px;
        transition: all 0.2s ease;
      }

      .share-option:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-light);
      }

      .share-icon {
        width: 48px;
        height: 48px;
        background: var(--secondary-color);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        font-size: 1.5rem;
      }

      .share-content {
        flex: 1;
      }

      .share-content h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
      }

      .share-content p {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .share-btn {
        padding: 10px 20px;
        background: var(--primary-color);
        border: none;
        border-radius: var(--radius-sm);
        color: white;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s ease;
      }

      .share-btn:hover {
        background: var(--primary-hover);
      }

      .export-buttons {
        display: flex;
        gap: 8px;
      }

      .export-btn {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        background: transparent;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.875rem;
        color: var(--text-secondary);
        transition: all 0.2s ease;
      }

      .export-btn:hover {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
      }

      /* Animations */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: scale(1);
        }
        to {
          opacity: 0;
          transform: scale(0.95);
        }
      }

      /* Toast notifications */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 12px 20px;
        border-radius: var(--radius-md);
        z-index: 1000;
        font-weight: 500;
        box-shadow: var(--shadow-medium);
      }

      /* Enhanced Loading States System */
      .loading {
        position: relative;
        pointer-events: none;
        transition: all var(--duration-200) var(--ease-out);
      }

      /* Global loading spinner */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid var(--gray-200);
        border-top: 2px solid var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-spinner.small {
        width: 16px;
        height: 16px;
        border-width: 1.5px;
      }

      .loading-spinner.large {
        width: 32px;
        height: 32px;
        border-width: 3px;
      }

      /* Loading overlay for components */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: inherit;
        opacity: 0;
        visibility: hidden;
        transition: all var(--duration-300) var(--ease-out);
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      /* Button loading states */
      .btn-loading {
        position: relative;
        color: transparent !important;
        pointer-events: none;
      }

      .btn-loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      /* Input loading states */
      .input-loading {
        position: relative;
      }

      .input-loading::after {
        content: '';
        position: absolute;
        right: 12px;
        top: 50%;
        width: 16px;
        height: 16px;
        margin-top: -8px;
        border: 2px solid var(--gray-300);
        border-top: 2px solid var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      /* Skeleton loading */
      .skeleton {
        background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
        background-size: 200% 100%;
        animation: skeletonLoading 1.5s infinite;
        border-radius: var(--radius-md);
      }

      @keyframes skeletonLoading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      .skeleton-text {
        height: 16px;
        margin-bottom: var(--space-2);
      }

      .skeleton-text.short { width: 60%; }
      .skeleton-text.medium { width: 80%; }
      .skeleton-text.long { width: 100%; }

      /* Pulse loading animation */
      .pulse-loading {
        animation: pulseLoading 1.5s ease-in-out infinite;
      }

      @keyframes pulseLoading {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Enhanced Error States System */
      .error-state {
        background: linear-gradient(135deg, var(--error-50), rgba(239, 68, 68, 0.05));
        border: 1px solid var(--error-200);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin: var(--space-2) 0;
        animation: errorAppear var(--duration-400) var(--ease-out);
      }

      .error-state .error-icon {
        color: var(--error-500);
        font-size: 1.5rem;
        margin-bottom: var(--space-2);
      }

      .error-state .error-title {
        color: var(--error-700);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--space-1);
      }

      .error-state .error-message {
        color: var(--error-600);
        font-size: var(--font-size-sm);
        line-height: var(--line-height-relaxed);
      }

      .error-state .error-actions {
        margin-top: var(--space-3);
        display: flex;
        gap: var(--space-2);
      }

      .error-retry-btn {
        background: var(--error-500);
        color: white;
        border: none;
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        cursor: pointer;
        transition: all var(--duration-200) var(--ease-out);
      }

      .error-retry-btn:hover {
        background: var(--error-600);
        transform: translateY(-1px);
      }

      /* Input error states */
      .input-error {
        border-color: var(--error-500) !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        animation: inputErrorShake var(--duration-400) var(--ease-out);
      }

      .input-error-message {
        color: var(--error-600);
        font-size: var(--font-size-xs);
        margin-top: var(--space-1);
        display: flex;
        align-items: center;
        gap: var(--space-1);
        animation: fadeInUp var(--duration-300) var(--ease-out);
      }

      /* Form validation states */
      .form-field.error .field-label {
        color: var(--error-600);
      }

      .form-field.error .field-input {
        border-color: var(--error-500);
        background: var(--error-50);
      }

      .form-field.success .field-input {
        border-color: var(--success-500);
        background: var(--success-50);
      }

      /* Network error states */
      .network-error {
        background: linear-gradient(135deg, var(--warning-50), rgba(251, 146, 60, 0.05));
        border: 1px solid var(--warning-200);
        color: var(--warning-700);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin: var(--space-2) 0;
        animation: slideInFromTop var(--duration-400) var(--ease-out);
      }

      .network-error .error-icon {
        color: var(--warning-500);
        font-size: 1.25rem;
      }

      /* Error animations */
      @keyframes errorAppear {
        0% {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes inputErrorShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
        20%, 40%, 60%, 80% { transform: translateX(3px); }
      }

      @keyframes slideInFromTop {
        0% {
          opacity: 0;
          transform: translateY(-20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Improved mobile responsiveness */
      @media (max-width: 768px) {
        .header-controls {
          gap: 8px;
        }

        .connection-status {
          display: none;
        }

        .message-actions {
          position: static;
          opacity: 1;
          transform: none;
          margin-top: 8px;
          justify-content: center;
          background: transparent;
          border: none;
          box-shadow: none;
        }

        .search-modal-content,
        .share-modal-content {
          width: 95%;
          margin: 20px;
        }

        .toast {
          right: 10px;
          left: 10px;
          top: 10px;
        }
      }

      /* Community Templates */
      .community-modal-content {
        max-width: 800px;
        width: 95%;
        max-height: 90vh;
        padding: 0;
      }

      .community-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        gap: 20px;
      }

      .community-search {
        position: relative;
        flex: 1;
        max-width: 300px;
      }

      .community-search input {
        width: 100%;
        padding: 8px 40px 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        background: var(--background-color);
        color: var(--text-color);
      }

      .community-search input:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .community-search .material-symbols-outlined {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.2rem;
        pointer-events: none;
      }

      .community-filters {
        display: flex;
        gap: 8px;
        padding: 20px 24px 0;
        flex-wrap: wrap;
        max-height: 120px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
      }

      .community-filters::-webkit-scrollbar {
        height: 4px;
      }

      .community-filters::-webkit-scrollbar-track {
        background: transparent;
      }

      .community-filters::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 2px;
      }

      .community-filter {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        background: transparent;
        border-radius: 20px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-secondary);
      }

      .community-filter.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
      }

      .community-filter:hover {
        background: var(--secondary-color);
        color: var(--text-color);
      }

      .community-templates {
        padding: 20px 24px;
        max-height: 500px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }

      .template-card {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .template-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .template-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .template-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
      }

      .template-card-category {
        background: var(--primary-color);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .template-card-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 12px;
      }

      .template-card-preview {
        background: rgba(16, 163, 127, 0.1);
        border-left: 3px solid var(--primary-color);
        padding: 8px 12px;
        font-size: 0.85rem;
        color: var(--text-color);
        font-style: italic;
        margin-bottom: 16px;
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      }

      .template-card-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .template-card-rating {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .template-card-usage {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Analytics */
      .analytics-modal-content {
        max-width: 900px;
        width: 95%;
        max-height: 90vh;
        padding: 0;
      }

      .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
      }

      .analytics-content {
        padding: 24px;
        max-height: 600px;
        overflow-y: auto;
      }

      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
      }

      .analytics-card {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .analytics-icon {
        width: 48px;
        height: 48px;
        background: var(--primary-color);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
      }

      .analytics-info h4 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 4px;
      }

      .analytics-info p {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .analytics-chart {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 20px;
      }

      .analytics-chart h4 {
        margin-bottom: 16px;
        color: var(--text-color);
      }

      .chart-container {
        height: 200px;
        display: flex;
        align-items: end;
        justify-content: space-between;
        gap: 4px;
        padding: 20px 0;
      }

      .chart-bar {
        background: var(--primary-color);
        border-radius: 4px 4px 0 0;
        min-width: 20px;
        transition: all 0.3s ease;
        position: relative;
      }

      .chart-bar:hover {
        background: var(--primary-hover);
      }

      .chart-bar::after {
        content: attr(data-value);
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75rem;
        color: var(--text-secondary);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .chart-bar:hover::after {
        opacity: 1;
      }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@100..900&family=Phetsarath:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
  </head>
  <body>
    <div class="container">
      <div class="sidebar-overlay"></div>
      <aside class="sidebar">
        <div class="sidebar-header">
          <h2>Lao Chat</h2>
        </div>
        <button class="new-chat-btn">
          <span class="material-symbols-outlined">add</span>
          ສົນທະນາໃໝ່
        </button>
        <div class="chat-history"></div>



        <div class="sidebar-footer">


          <button id="buy-me-a-coffee-btn" class="sidebar-btn">
            <span class="material-symbols-outlined">coffee</span>
            <span>Buy Me a Coffee</span>
          </button>
          <button id="about-me-btn" class="sidebar-btn">
            <span class="material-symbols-outlined">person</span>
            <span>About me</span>
          </button>
        </div>
      </aside>

      <main class="chat-area">
        <header class="chat-header">
          <button class="menu-btn">
            <span class="material-symbols-outlined">menu</span>
          </button>
          <div class="chat-header-title" data-translate="chatTitle">
            Lao Chat
          </div>
          <div class="header-controls">
            <div class="connection-status" id="connection-status">
              <span class="status-dot"></span>
              <span class="status-text">ເຊື່ອມຕໍ່ແລ້ວ</span>
            </div>
            <button class="header-btn" id="search-btn">
              <span class="material-symbols-outlined">search</span>
            </button>
            <button class="header-btn" id="share-btn">
              <span class="material-symbols-outlined">share</span>
            </button>
          </div>
        </header>

        <div class="chat-container"></div>

        <div class="chat-input-area">
          <form id="chat-form" class="chat-form">
            <div class="input-container">
              <textarea
                id="user-input"
                data-translate-placeholder="typeYourMessage"
                placeholder="ພິມຂໍ້ຄວາມຂອງທ່ານທີ່ນີ້..."
                required
                rows="1"
              ></textarea>
              <div class="char-counter">
                <span class="current">0</span>/<span class="max">2000</span>
              </div>
            </div>
            
            <div class="input-actions">
              <button type="submit" class="send-btn" title="ສົ່ງຂໍ້ຄວາມ">
                <span class="material-symbols-outlined">send</span>
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>

    <!-- Coffee Modal -->
    <div id="coffee-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div class="modal-qr-container">
          <img src="front/QR.jpg" alt="QR Code 1" />
          <img src="front/QR1.jpg" alt="QR Code 2" />
        </div>
        <p data-translate="thankYouSupport">
          If you find this tool helpful, please consider supporting me.
        </p>
      </div>
    </div>

    <!-- About Me Modal -->
    <div id="about-me-modal" class="modal">
      <div class="modal-content about-me-modal-content">
        <span class="close-btn">&times;</span>
        <div class="about-me-header">
          <h3>About Me</h3>
          <img src="front/Khamko_congua.jpg" alt="Khamko" />
        </div>
        <div class="about-me-body">
          <p>
            Hello, my name is Khamko. I am from Laos and currently studying
            Information Technology at University of Science and Education - The
            University of Danang. At the same time, I am working as a Developer
            at a company in Da Nang, Viet Nam.
          </p>
          <p>
            If you would like to get in touch, please feel free to contact me
            via Facebook or Email.
          </p>
          <p>
            Facebook:
            <a
              href="https://www.facebook.com/khamkoxys"
              target="_blank"
              rel="noopener noreferrer"
              >khamko</a
            ><br />
            Email:
            <a href="mailto:khamko@pascaliaasia.com"
              >khamko@pascaliaasia.com</a
            >
          </p>
        </div>
      </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="modal">
      <div class="modal-content search-modal-content">
        <div class="search-header">
          <h3>ຄົ້ນຫາໃນປະຫວັດການສົນທະນາ</h3>
          <span class="close-btn" id="search-close">&times;</span>
        </div>
        <div class="search-input-container">
          <input
            type="text"
            id="search-input"
            placeholder="ພິມຄໍາທີ່ຕ້ອງການຄົ້ນຫາ..."
          />
          <button id="search-submit">
            <span class="material-symbols-outlined">search</span>
          </button>
        </div>
        <div class="search-filters">
          <button class="filter-btn active" data-filter="all">ທັງໝົດ</button>
          <button class="filter-btn" data-filter="user">ຂ້ອຍ</button>
          <button class="filter-btn" data-filter="bot">AI</button>
        </div>
        <div class="search-results" id="search-results">
          <div class="search-placeholder">
            <span class="material-symbols-outlined">search</span>
            <p>ພິມຄໍາທີ່ຕ້ອງການຄົ້ນຫາ</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
      <div class="modal-content share-modal-content">
        <div class="share-header">
          <h3>ແບ່ງປັນການສົນທະນາ</h3>
          <span class="close-btn" id="share-close">&times;</span>
        </div>
        <div class="share-options">
          <div class="share-option">
            <div class="share-icon">
              <span class="material-symbols-outlined">link</span>
            </div>
            <div class="share-content">
              <h4>ແບ່ງປັນລິ້ງ</h4>
              <p>ສ້າງລິ້ງສາທາລະນະສໍາລັບການສົນທະນານີ້</p>
            </div>
            <button class="share-btn" id="create-share-link">ສ້າງລິ້ງ</button>
          </div>
        </div>
      </div>
    </div>





    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chatForm = document.getElementById("chat-form");
        const userInput = document.getElementById("user-input");
        const chatContainer = document.querySelector(".chat-container");
        const buyMeACoffeeBtn = document.getElementById("buy-me-a-coffee-btn");
        const coffeeModal = document.getElementById("coffee-modal");
        const aboutMeBtn = document.getElementById("about-me-btn");
        const aboutMeModal = document.getElementById("about-me-modal");
        const closeBtn = document.querySelector(".close-btn");
        const menuBtn = document.querySelector(".menu-btn");
        const sidebar = document.querySelector(".sidebar");
        const sidebarOverlay = document.querySelector(".sidebar-overlay");
        const newChatBtn = document.querySelector(".new-chat-btn");
        const chatHistoryContainer = document.querySelector(".chat-history");

        // New UI elements

        const searchBtn = document.getElementById("search-btn");
        const shareBtn = document.getElementById("share-btn");
        const searchModal = document.getElementById("search-modal");
        const shareModal = document.getElementById("share-modal");
        const connectionStatus = document.getElementById("connection-status");

        // --- Modal Logic ---
        function setupModal(btn, modal) {
          const close = modal.querySelector(".close-btn");

          btn.addEventListener("click", () => {
            modal.style.display = "flex";
          });

          close.addEventListener("click", () => {
            modal.style.display = "none";
          });

          window.addEventListener("click", (event) => {
            if (event.target == modal) {
              modal.style.display = "none";
            }
          });
        }

        setupModal(buyMeACoffeeBtn, coffeeModal);
        setupModal(aboutMeBtn, aboutMeModal);

        // State management

        let connectionState = "online";
        let isGenerating = false;
        let isRecording = false;
        let mediaRecorder = null;
        let selectedFiles = [];
        let messageTemplates = {
          greeting: "ສະບາຍດີ! ຂ້ອຍຕ້ອງການຄວາມຊ່ວຍເຫຼືອ",
          question: "ຂ້ອຍມີຄໍາຖາມກ່ຽວກັບ",
          translate: "ກະລຸນາແປຂໍ້ຄວາມນີ້ເປັນພາສາລາວ:",
          explain: "ກະລຸນາອະທິບາຍໃຫ້ຂ້ອຍຟັງກ່ຽວກັບ",
        };

        // Virtual Scrolling for Performance
        class VirtualChatList {
          constructor(container, itemHeight = 120) {
            this.container = container;
            this.itemHeight = itemHeight;
            this.visibleStart = 0;
            this.visibleEnd = 0;
            this.scrollTop = 0;
            this.totalHeight = 0;
            this.messages = [];
            this.renderedMessages = new Map();

            this.setupScrollListener();
          }

          setupScrollListener() {
            this.container.addEventListener("scroll", () => {
              this.scrollTop = this.container.scrollTop;
              this.updateVisibleRange();
              this.renderVisibleMessages();
            });
          }

          updateVisibleRange() {
            const containerHeight = this.container.clientHeight;
            this.visibleStart = Math.floor(this.scrollTop / this.itemHeight);
            this.visibleEnd = Math.min(
              this.visibleStart +
                Math.ceil(containerHeight / this.itemHeight) +
                2,
              this.messages.length
            );
          }

          addMessage(message) {
            this.messages.push(message);
            this.totalHeight = this.messages.length * this.itemHeight;
            this.updateVisibleRange();
            this.renderVisibleMessages();
          }

          renderVisibleMessages() {
            // Clear container
            this.container.innerHTML = "";

            // Create spacer for scrolling
            const spacer = document.createElement("div");
            spacer.style.height = `${this.totalHeight}px`;
            spacer.style.position = "relative";
            this.container.appendChild(spacer);

            // Render visible messages
            for (let i = this.visibleStart; i < this.visibleEnd; i++) {
              if (this.messages[i]) {
                const messageEl = this.createMessageElement(
                  this.messages[i],
                  i
                );
                messageEl.style.position = "absolute";
                messageEl.style.top = `${i * this.itemHeight}px`;
                messageEl.style.width = "100%";
                spacer.appendChild(messageEl);
              }
            }
          }

          createMessageElement(message, index) {
            const messageEl = document.createElement("div");
            messageEl.className = `message ${message.sender}`;
            messageEl.innerHTML = `
              <div class="icon">
                <span class="material-symbols-outlined">
                  ${message.sender === "user" ? "account_circle" : "smart_toy"}
                </span>
              </div>
              <div class="text">
                <div class="message-text">${message.text}</div>
              </div>
            `;
            return messageEl;
          }
        }

        // Initialize virtual scrolling for large chat histories
        let virtualList = null;

        // Service Worker Registration
        if ("serviceWorker" in navigator && location.protocol !== "file:") {
          window.addEventListener("load", () => {
            navigator.serviceWorker
              .register("./sw.js")
              .then((registration) => {
                console.log("SW registered: ", registration);
              })
              .catch((registrationError) => {
                console.log("SW registration failed: ", registrationError);
              });
          });
        }

        let currentChatId = null;
        let chatHistories = {}; // { "chatId1": [{sender: "user", message: "hi"}, ...], ... }
        let currentTheme = localStorage.getItem('theme') || 'light'; // Theme system

        // --- Language / i18n ---
        const languageStrings = {
          lo: {
            chatTitle: "Lao Chat",
            newChat: "ສົນທະນາໃໝ່",
            language: "ພາສາ:",
            thankYouSupport: "If you find this tool helpful, please consider supporting me.",
            typeYourMessage: "ພິມຂໍ້ຄວາມຂອງທ່ານທີ່ນີ້...",
            welcomeMessage:
              "ສະບາຍດີ! ຂ້ອຍແມ່ນ Lao Chat, ຂ້ອຍສາມາດຊ່ວຍຫຍັງເຈົ້າໄດ້ແດ່?",
            thinking: "ກຳລັງຄິດ...",
            errorMessage: "ຂໍອະໄພ, ມີຂໍ້ຜິດພາດເກີດຂຶ້ນ:",
            copied: "ສຳເນົາແລ້ວ!",
          },
          vi: {
            chatTitle: "Lao Chat",
            newChat: "Trò chuyện mới",
            language: "Ngôn ngữ:",
            thankYouSupport: "Cảm ơn sự ủng hộ của bạn!",
            typeYourMessage: "Nhập tin nhắn của bạn ở đây...",
            welcomeMessage:
              "Xin chào! Tôi là Lao Chat, tôi có thể giúp gì cho bạn?",
            thinking: "Đang suy nghĩ...",
            errorMessage: "Xin lỗi, đã có lỗi xảy ra:",
            copied: "Đã sao chép!",
          },
          en: {
            chatTitle: "Lao Chat",
            newChat: "New Chat",
            buyMeACoffee: "Buy Me a Coffee",
            language: "Language:",
            thankYouSupport: "Thank you for your support!",
            typeYourMessage: "Type your message here...",
            welcomeMessage: "Hello! I'm Lao Chat, how can I help you?",
            thinking: "Thinking...",
            errorMessage: "Sorry, an error occurred:",
            copied: "Copied!",
          },
        };

        // Initialize Lao language as default
        function initializeLaoLanguage() {
          document.documentElement.lang = "lo";

          document.querySelectorAll("[data-translate]").forEach((el) => {
            const key = el.dataset.translate;
            if (languageStrings.lo[key]) {
              el.textContent = languageStrings.lo[key];
            }
          });

          document
            .querySelectorAll("[data-translate-placeholder]")
            .forEach((el) => {
              const key = el.dataset.translatePlaceholder;
              if (languageStrings.lo[key]) {
                el.placeholder = languageStrings.lo[key];
              }
            });
        }

        // Theme Management
        function setTheme(theme) {
          currentTheme = theme;
          document.body.className = theme === 'dark' ? 'dark-theme' : '';
          localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          setTheme(newTheme);
        }

        // Connection Status Management
        function updateConnectionStatus(status) {
          connectionState = status;
          const statusText = connectionStatus.querySelector(".status-text");

          connectionStatus.className = `connection-status ${status}`;

          switch (status) {
            case "online":
              statusText.textContent = "ເຊື່ອມຕໍ່ແລ້ວ";
              break;
            case "offline":
              statusText.textContent = "ບໍ່ມີອິນເຕີເນັດ";
              break;
            case "connecting":
              statusText.textContent = "ກຳລັງເຊື່ອມຕໍ່...";
              break;
          }
        }

        // Message Actions
        function createMessageActions(messageElement, message, sender) {
          const isBot = sender === "bot";
          if (!isBot) return; // Only show actions for bot messages

          const actionsHtml = `
            <div class="message-actions">
              <button class="action-btn" data-action="copy" title="ສຳເນົາ"><span class="material-symbols-outlined">content_copy</span></button>
            </div>
            <div class="message-meta">
              <span class="message-timestamp">${formatTime(new Date())}</span>
            </div>
          `;

          messageElement.insertAdjacentHTML("beforeend", actionsHtml);

          // Add event listeners for actions
          const actionBtns = messageElement.querySelectorAll(".action-btn");
          actionBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              handleMessageAction(btn.dataset.action, messageElement, message);
            });
          });
        }

        function handleMessageAction(action, messageElement, message) {
          switch (action) {
            case "copy":
              navigator.clipboard.writeText(message).then(() => {
                showToast("ສຳເນົາແລ້ວ!");
              });
              break;
            case "like":
              toggleReaction(messageElement, "like");
              break;
            case "dislike":
              toggleReaction(messageElement, "dislike");
              break;
            case "edit":
              editMessage(messageElement, message);
              break;
            case "delete":
              deleteMessage(messageElement);
              break;
            case "regenerate":
              regenerateResponse(messageElement);
              break;
          }
        }

        function toggleReaction(messageElement, type) {
          const actionBtn = messageElement.querySelector(
            `[data-action="${type}"]`
          );
          actionBtn.classList.toggle("active");

          // Add reaction to message
          let reactionsContainer =
            messageElement.querySelector(".message-reactions");
          if (!reactionsContainer) {
            reactionsContainer = document.createElement("div");
            reactionsContainer.className = "message-reactions";
            messageElement
              .querySelector(".message-text")
              .appendChild(reactionsContainer);
          }

          const emoji = type === "like" ? "👍" : "👎";
          const existingReaction = reactionsContainer.querySelector(
            `[data-reaction="${type}"]`
          );

          if (existingReaction) {
            existingReaction.remove();
          } else {
            const reaction = document.createElement("span");
            reaction.className = "reaction active";
            reaction.dataset.reaction = type;
            reaction.innerHTML = `${emoji} 1`;
            reactionsContainer.appendChild(reaction);
          }
        }

        function showToast(message) {
          const toast = document.createElement("div");
          toast.className = "toast";
          toast.textContent = message;
          toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            z-index: 1000;
            animation: slideIn 0.3s ease;
          `;

          document.body.appendChild(toast);

          setTimeout(() => {
            toast.style.animation = "slideOut 0.3s ease";
            setTimeout(() => toast.remove(), 300);
          }, 2000);
        }

        function formatTime(date) {
          return date.toLocaleTimeString("lo-LA", {
            hour: "2-digit",
            minute: "2-digit",
          });
        }

        // Search functionality
        function searchMessages(query, filter = "all") {
          const results = [];
          const searchQuery = query.toLowerCase();

          Object.values(chatHistories).forEach((chatMessages) => {
            chatMessages.forEach((msg, index) => {
              if (filter !== "all" && msg.sender !== filter) return;

              if (msg.message.toLowerCase().includes(searchQuery)) {
                results.push({
                  ...msg,
                  index,
                  chatId: Object.keys(chatHistories).find(
                    (id) => chatHistories[id] === chatMessages
                  ),
                });
              }
            });
          });

          displaySearchResults(results, query);
        }

        function displaySearchResults(results, query) {
          const resultsContainer = document.getElementById("search-results");

          if (results.length === 0) {
            resultsContainer.innerHTML = `
              <div class="search-placeholder">
                <span class="material-symbols-outlined">search_off</span>
                <p>ບໍ່ພົບຜົນການຄົ້ນຫາ</p>
              </div>
            `;
            return;
          }

          resultsContainer.innerHTML = results
            .map((result) => {
              const highlightedText = result.message.replace(
                new RegExp(query, "gi"),
                (match) => `<span class="search-highlight">${match}</span>`
              );

              return `
              <div class="search-result-item" data-chat-id="${
                result.chatId
              }" data-message-index="${result.index}">
                <div class="search-result-meta">
                  <span>${result.sender === "user" ? "ຂ້ອຍ" : "AI"}</span>
                  <span>${formatTime(new Date())}</span>
                </div>
                <div class="search-result-text">${highlightedText}</div>
              </div>
            `;
            })
            .join("");

          // Add click handlers for search results
          resultsContainer
            .querySelectorAll(".search-result-item")
            .forEach((item) => {
              item.addEventListener("click", () => {
                const chatId = item.dataset.chatId;
                loadChat(chatId);
                searchModal.style.display = "none";
                sidebar.classList.remove("show-sidebar");
              });
            });
        }

        // --- Xử lý Lịch sử Chat ---

        function loadChatHistories() {
          const storedHistories = localStorage.getItem("chatHistories");
          if (storedHistories) {
            chatHistories = JSON.parse(storedHistories);
          }
          const storedChatId = localStorage.getItem("currentChatId");
          currentChatId = storedChatId;

          if (!currentChatId || !chatHistories[currentChatId]) {
            createNewChat();
          } else {
            loadChat(currentChatId);
          }
          renderChatHistoryList();
        }

        function renderChatHistoryList() {
          chatHistoryContainer.innerHTML = "<ul></ul>";
          const ul = chatHistoryContainer.querySelector("ul");
          
          const sortedChatIds = Object.keys(chatHistories).reverse();
          
          sortedChatIds.forEach((id, index) => {
            const firstUserMessage = chatHistories[id].find(
              (m) => m.sender === "user"
            );
            const title = firstUserMessage?.message.substring(0, 35) || "ສົນທະນາໃໝ່";
            const messageCount = chatHistories[id].length;
            
            const li = document.createElement("li");
            li.dataset.chatId = id;
            li.style.animationDelay = `${index * 50}ms`;
            li.classList.add("chat-history-item");
            
            // Create chat icon with message count indicator
            const chatIcon = document.createElement("div");
            chatIcon.classList.add("chat-icon");
            chatIcon.innerHTML = `<span class="material-symbols-outlined">chat</span>`;
            
            // Create title container
            const titleContainer = document.createElement("div");
            titleContainer.classList.add("chat-title");
            titleContainer.textContent = title;
            
            // Create metadata (message count, time)
            const metadata = document.createElement("div");
            metadata.classList.add("chat-metadata");
            metadata.innerHTML = `
              <span class="message-count">${messageCount}</span>
              <span class="chat-time">${new Date().toLocaleDateString('lo-LA', { month: 'short', day: 'numeric' })}</span>
            `;
            
            li.appendChild(chatIcon);
            li.appendChild(titleContainer);
            li.appendChild(metadata);
            
            if (id === currentChatId) {
              li.classList.add("active");
            }
            
            li.addEventListener("click", () => {
              // Remove active class from all items
              ul.querySelectorAll("li").forEach(item => item.classList.remove("active"));
              // Add active class to clicked item
              li.classList.add("active");
              
              loadChat(id);
              sidebar.classList.remove("show-sidebar"); // Đóng sidebar trên mobile
            });
            
            ul.appendChild(li);
          });
          
          // Add entrance animation
          ul.classList.add("chat-list-animated");
        }

        function createNewChat() {
          chatContainer.innerHTML = "";
          const newChatId = `chat_${Date.now()}`;
          currentChatId = newChatId;
          chatHistories[currentChatId] = [];
          localStorage.setItem("currentChatId", currentChatId);
          const lang = "lo"; // Always use Lao
          // addMessage(languageStrings[lang].welcomeMessage, "bot");
          renderChatHistoryList();
          // Clear welcome message if there is one
          const welcomeMessage = document.querySelector(".welcome-placeholder");
          if (welcomeMessage) welcomeMessage.remove();
        }

        function loadChat(chatId) {
          currentChatId = chatId;
          localStorage.setItem("currentChatId", currentChatId);
          chatContainer.innerHTML = "";
          const messages = chatHistories[chatId] || [];
          if (messages.length === 0) {
            const lang = "lo"; // Always use Lao
            addWelcomePlaceholder(lang);
          } else {
            messages.forEach((msg) =>
              addMessage(msg.message, msg.sender, false)
            ); // false để không lưu lại
          }
          renderChatHistoryList();
        }

        function saveMessageToHistory(message, sender) {
          if (!chatHistories[currentChatId]) {
            chatHistories[currentChatId] = [];
          }
          chatHistories[currentChatId].push({ message, sender });
          localStorage.setItem("chatHistories", JSON.stringify(chatHistories));
          // Cập nhật tiêu đề nếu đây là tin nhắn đầuแรก của người dùng
          if (
            chatHistories[currentChatId].filter((m) => m.sender === "user")
              .length === 1
          ) {
            renderChatHistoryList();
          }
        }

        menuBtn.addEventListener("click", () => {
          sidebar.classList.toggle("show-sidebar");
          sidebarOverlay.classList.toggle("active");
        });

        // Enhanced Gesture Support for Sidebar
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let isSwiping = false;
        let swipeThreshold = 50;
        let velocityThreshold = 0.3;

        function handleTouchStart(e) {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          isSwiping = false;
        }

        function handleTouchMove(e) {
          if (!touchStartX || !touchStartY) return;
          
          touchEndX = e.touches[0].clientX;
          touchEndY = e.touches[0].clientY;
          
          const deltaX = touchEndX - touchStartX;
          const deltaY = touchEndY - touchStartY;
          
          // Check if horizontal swipe
          if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
            isSwiping = true;
            e.preventDefault();
            
            // Visual feedback for sidebar drag
            if (deltaX > 0 && touchStartX < 50 && !sidebar.classList.contains('show-sidebar')) {
              const progress = Math.min(deltaX / 280, 1);
              sidebar.style.transform = `translateX(${-100 + (progress * 100)}%)`;
              sidebarOverlay.style.opacity = progress * 0.5;
            } else if (deltaX < 0 && sidebar.classList.contains('show-sidebar')) {
              const progress = Math.max((280 + deltaX) / 280, 0);
              sidebar.style.transform = `translateX(${-100 + (progress * 100)}%)`;
              sidebarOverlay.style.opacity = progress * 0.5;
            }
          }
        }

        function handleTouchEnd(e) {
          if (!isSwiping) return;
          
          const deltaX = touchEndX - touchStartX;
          const deltaY = touchEndY - touchStartY;
          const distance = Math.abs(deltaX);
          const velocity = distance / (Date.now() - touchStartTime);
          
          // Reset transforms
          sidebar.style.transform = '';
          sidebarOverlay.style.opacity = '';
          
          // Determine swipe action
          if (distance > swipeThreshold || velocity > velocityThreshold) {
            if (deltaX > 0 && touchStartX < 50 && !sidebar.classList.contains('show-sidebar')) {
              // Swipe right from left edge - open sidebar
              sidebar.classList.add('show-sidebar');
              sidebarOverlay.classList.add('active');
            } else if (deltaX < 0 && sidebar.classList.contains('show-sidebar')) {
              // Swipe left - close sidebar
              sidebar.classList.remove('show-sidebar');
              sidebarOverlay.classList.remove('active');
            }
          }
          
          // Reset values
          touchStartX = 0;
          touchStartY = 0;
          touchEndX = 0;
          touchEndY = 0;
          isSwiping = false;
        }

        let touchStartTime = 0;

        // Add touch event listeners
        document.addEventListener('touchstart', (e) => {
          touchStartTime = Date.now();
          handleTouchStart(e);
        }, { passive: false });

        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('touchend', handleTouchEnd);

        // Đóng sidebar khi click bên ngoài
        sidebarOverlay.addEventListener("click", () => {
            sidebar.classList.remove("show-sidebar");
            sidebarOverlay.classList.remove("active");
        });

        newChatBtn.addEventListener("click", (e) => {
            // Add ripple effect
            addRippleEffect(newChatBtn, e);
            
            // Add loading state briefly
            newChatBtn.style.opacity = '0.7';
            newChatBtn.style.transform = 'translateY(-1px) scale(0.98)';
            
            setTimeout(() => {
                createNewChat();
                sidebar.classList.remove("show-sidebar");
                sidebarOverlay.classList.remove("active");
                
                // Reset button state
                newChatBtn.style.opacity = '';
                newChatBtn.style.transform = '';
            }, 150);
        });



        // --- Search Modal ---
        searchBtn.addEventListener("click", () => {
          searchModal.style.display = "flex";
          document.getElementById("search-input").focus();
        });

        document
          .getElementById("search-close")
          .addEventListener("click", () => {
            searchModal.style.display = "none";
          });

        document
          .getElementById("search-input")
          .addEventListener("input", (e) => {
            const query = e.target.value.trim();
            if (query.length > 2) {
              const activeFilter =
                document.querySelector(".filter-btn.active").dataset.filter;
              searchMessages(query, activeFilter);
            }
          });

        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".filter-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            const query = document.getElementById("search-input").value.trim();
            if (query.length > 2) {
              searchMessages(query, btn.dataset.filter);
            }
          });
        });

        // --- Share Modal ---
        shareBtn.addEventListener("click", () => {
          shareModal.style.display = "flex";
        });

        document.getElementById("share-close").addEventListener("click", () => {
          shareModal.style.display = "none";
        });

        document
          .getElementById("create-share-link")
          .addEventListener("click", () => {
            // Lưu dữ liệu cuộc trò chuyện để chia sẻ
            try {
              const sharedChatsKey = 'sharedChats';
              let sharedChats = {};
              
              // Lấy dữ liệu chia sẻ hiện có (nếu có)
              const existingSharedChats = localStorage.getItem(sharedChatsKey);
              if (existingSharedChats) {
                sharedChats = JSON.parse(existingSharedChats);
              }

              // Thêm cuộc trò chuyện hiện tại vào danh sách chia sẻ
              sharedChats[currentChatId] = {
                messages: chatHistories[currentChatId],
                sharedAt: new Date().toISOString(),
                title: `Cuộc trò chuyện ${new Date().toLocaleDateString('vi-VN')}`
              };

              // Lưu vào localStorage
              localStorage.setItem(sharedChatsKey, JSON.stringify(sharedChats));

              // Tạo URL chia sẻ - sử dụng URL parameters để tương thích với GitHub Pages
              const baseUrl = window.location.href.replace(/\/[^\/]*$/, '');
              const shareUrl = `${baseUrl}/shared/?id=${currentChatId}`;
              
              navigator.clipboard.writeText(shareUrl).then(() => {
                showToast("ລິ້ງຖືກສຳເນົາແລ້ວ! ໃຫ້ແບ່ງປັນໄດ້ແລ້ວ! 🎉");
                shareModal.style.display = "none";
              }).catch(() => {
                // Fallback nếu clipboard API không hoạt động
                prompt("ສຳເນົາລິ້ງນີ້:", shareUrl);
                showToast("ກະລຸນາສຳເນົາລິ້ງດ້ວຍຕົນເອງ");
                shareModal.style.display = "none";
              });
            } catch (error) {
              console.error('Lỗi khi chia sẻ:', error);
              showToast("ເກີດຂໍ້ຜິດພາດໃນການແບ່ງປັນ!", "error");
            }
          });



        // --- Modal Management ---
        buyMeACoffeeBtn.addEventListener("click", () => {
          coffeeModal.style.display = "flex";
        });

        aboutMeBtn.addEventListener("click", () => {
          aboutMeModal.style.display = "flex";
        });

        closeBtn.addEventListener("click", () => {
          coffeeModal.style.display = "none";
          aboutMeModal.style.display = "none";
        });

        window.addEventListener("click", (event) => {
          if (event.target == coffeeModal) {
            coffeeModal.style.display = "none";
          }
          if (event.target == searchModal) {
            searchModal.style.display = "none";
          }
          if (event.target == shareModal) {
            shareModal.style.display = "none";
          }
          if (event.target == aboutMeModal) {
            aboutMeModal.style.display = "none";
          }
        });

        // --- Advanced Features ---

        // Templates Panel
        const templatesPanel = document.getElementById("templates-panel");

        // Templates
        document.querySelectorAll(".template-item").forEach((item) => {
          item.addEventListener("click", () => {
            const template = messageTemplates[item.dataset.template];
            userInput.value = template;
            templatesPanel.classList.remove("show");
            userInput.focus();
          });
        });



        // Threaded Replies
        function createThreadedReply(parentMessage, replyText) {
          const parentElement = parentMessage.parentElement;
          let threadContainer =
            parentElement.querySelector(".thread-container");

          if (!threadContainer) {
            threadContainer = document.createElement("div");
            threadContainer.className = "thread-container";
            threadContainer.innerHTML = `
              <div class="thread-toggle">
                <span class="material-symbols-outlined">forum</span>
                <span>1 ການຕອບກັບ</span>
              </div>
              <div class="thread-messages"></div>
              <div class="thread-input">
                <input type="text" placeholder="ຕອບກັບໃນກະທູ້...">
                <button>ສົ່ງ</button>
              </div>
            `;
            parentElement.appendChild(threadContainer);

            // Add thread toggle functionality
            const toggle = threadContainer.querySelector(".thread-toggle");
            const messages = threadContainer.querySelector(".thread-messages");
            const input = threadContainer.querySelector(".thread-input input");
            const sendBtn = threadContainer.querySelector(
              ".thread-input button"
            );

            toggle.addEventListener("click", () => {
              toggle.classList.toggle("expanded");
              messages.classList.toggle("expanded");
            });

            sendBtn.addEventListener("click", () => {
              if (input.value.trim()) {
                addThreadMessage(messages, input.value, "user");
                input.value = "";
                updateThreadCount(toggle);
              }
            });

            input.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                sendBtn.click();
              }
            });
          }

          const messages = threadContainer.querySelector(".thread-messages");
          addThreadMessage(messages, replyText, "bot");
          updateThreadCount(threadContainer.querySelector(".thread-toggle"));
        }

        function addThreadMessage(container, text, sender) {
          const messageEl = document.createElement("div");
          messageEl.className = `thread-message ${sender}`;
          messageEl.innerHTML = `
            <div class="thread-message-content">${text}</div>
            <div class="thread-message-meta">
              <span>${sender === "user" ? "ຂ້ອຍ" : "AI"}</span>
              <span>${formatTime(new Date())}</span>
            </div>
          `;
          container.appendChild(messageEl);
        }

        function updateThreadCount(toggle) {
          const container = toggle.parentElement;
          const messages = container.querySelectorAll(".thread-message");
          toggle.querySelector(
            "span:last-child"
          ).textContent = `${messages.length} ການຕອບກັບ`;
        }

        // --- Connection Status ---
        window.addEventListener("online", () =>
          updateConnectionStatus("online")
        );
        window.addEventListener("offline", () =>
          updateConnectionStatus("offline")
        );

        // Offline message queue
        let offlineMessageQueue = JSON.parse(
          localStorage.getItem("offlineMessages") || "[]"
        );

        function queueOfflineMessage(message) {
          offlineMessageQueue.push({
            message,
            timestamp: Date.now(),
            chatId: currentChatId,
          });
          localStorage.setItem(
            "offlineMessages",
            JSON.stringify(offlineMessageQueue)
          );
        }

        function processOfflineQueue() {
          if (offlineMessageQueue.length > 0 && connectionState === "online") {
            offlineMessageQueue.forEach(async (item) => {
              // Process queued messages
              await sendMessage(item.message);
            });
            offlineMessageQueue = [];
            localStorage.removeItem("offlineMessages");
          }
        }

        // Enhanced auto-resize input with character counter
        const charCounter = document.querySelector('.char-counter .current');
        const maxChars = 2000;
        
        userInput.addEventListener("input", function () {
          // Auto-resize functionality
          this.style.height = "auto";
          const maxHeight = window.innerWidth <= 768 ? 120 : 150;
          this.style.height = Math.min(this.scrollHeight, maxHeight) + "px";
          
          // Character counter
          const currentLength = this.value.length;
          if (charCounter) {
            charCounter.textContent = currentLength;
            
            const counterElement = document.querySelector('.char-counter');
            counterElement.classList.remove('warning', 'error');
            
            if (currentLength > maxChars * 0.8) {
              counterElement.classList.add('warning');
            }
            if (currentLength > maxChars) {
              counterElement.classList.add('error');
            }
          }
          
          // Update send button state
          const sendBtn = document.querySelector('.send-btn');
          if (sendBtn) {
            sendBtn.disabled = currentLength === 0 || currentLength > maxChars;
          }
          
          // Smooth scroll on mobile
          if (window.innerWidth <= 768) {
            setTimeout(() => {
              this.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
          }
        });

        // Handle Enter key
        userInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            if (!document.querySelector('.send-btn').disabled) {
              chatForm.dispatchEvent(new Event("submit"));
            }
          }
        });

        // Enhanced action buttons functionality
        const templatesBtn = document.querySelector('.templates-btn');
        const fileBtn = document.querySelector('.file-btn');
        const emojiBtn = document.querySelector('.emoji-btn');
        const voiceBtn = document.querySelector('.voice-btn');
        const sendBtn = document.querySelector('.send-btn');

        // Templates button
        if (templatesBtn) {
          templatesBtn.addEventListener('click', () => {
            const templatesPanel = document.getElementById('templates-panel');
            if (templatesPanel) {
              templatesPanel.style.display = templatesPanel.style.display === 'none' ? 'flex' : 'none';
              templatesBtn.classList.toggle('active');
            }
          });
        }

        // File upload button
        if (fileBtn) {
          const fileInput = fileBtn.querySelector('input[type="file"]');
          fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
              // Add visual feedback
              fileBtn.classList.add('active');
              setTimeout(() => fileBtn.classList.remove('active'), 2000);
              
              // Handle file upload (placeholder for future implementation)
              console.log('Files selected:', files.map(f => f.name));
            }
          });
        }

        // Emoji button (placeholder for future emoji picker)
        if (emojiBtn) {
          emojiBtn.addEventListener('click', () => {
            // Add some common emojis to input
            const emojis = ['😊', '👍', '❤️', '😂', '🤔', '👋', '🙏', '✨'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            userInput.value += randomEmoji;
            userInput.dispatchEvent(new Event('input'));
            userInput.focus();
          });
        }

        // Initialize send button state
        sendBtn.disabled = true; // Initially disabled until user types

        // Mobile scroll optimization
        function optimizeMobileScroll() {
          if (window.innerWidth <= 768) {
            // Prevent body scroll on mobile
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.height = '100%';
            
            // Ensure chat container can scroll properly
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
              chatContainer.style.overflowY = 'auto';
              chatContainer.style.webkitOverflowScrolling = 'touch';
            }
          }
        }

        // Call on load and resize
        optimizeMobileScroll();
        window.addEventListener('resize', optimizeMobileScroll);

        // Enhanced Mobile Scrolling and Pull-to-Refresh
        let pullToRefreshThreshold = 80;
        let isPulling = false;
        let pullDistance = 0;
        let pullStartY = 0;

        function handlePullToRefresh() {
          const pullIndicator = document.createElement('div');
          pullIndicator.className = 'pull-to-refresh-indicator';
          pullIndicator.innerHTML = `
            <div class="pull-icon">
              <span class="material-symbols-outlined">refresh</span>
            </div>
            <div class="pull-text">Kéo để làm mới</div>
          `;
          pullIndicator.style.cssText = `
            position: absolute;
            top: -80px;
            left: 0;
            right: 0;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--surface-primary);
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            transition: all var(--duration-200) var(--ease-out);
            z-index: 10;
          `;
          
          chatContainer.insertBefore(pullIndicator, chatContainer.firstChild);

          chatContainer.addEventListener('touchstart', (e) => {
            if (chatContainer.scrollTop === 0) {
              pullStartY = e.touches[0].clientY;
              isPulling = true;
            }
          });

          chatContainer.addEventListener('touchmove', (e) => {
            if (!isPulling || chatContainer.scrollTop > 0) return;
            
            const currentY = e.touches[0].clientY;
            pullDistance = Math.max(0, (currentY - pullStartY) * 0.5);
            
            if (pullDistance > 0) {
              e.preventDefault();
              pullIndicator.style.transform = `translateY(${Math.min(pullDistance, pullToRefreshThreshold)}px)`;
              
              if (pullDistance >= pullToRefreshThreshold) {
                pullIndicator.querySelector('.pull-text').textContent = 'Thả để làm mới';
                pullIndicator.querySelector('.pull-icon').style.transform = 'rotate(180deg)';
              } else {
                pullIndicator.querySelector('.pull-text').textContent = 'Kéo để làm mới';
                pullIndicator.querySelector('.pull-icon').style.transform = 'rotate(0deg)';
              }
            }
          });

          chatContainer.addEventListener('touchend', () => {
            if (!isPulling) return;
            
            if (pullDistance >= pullToRefreshThreshold) {
              // Trigger refresh
              pullIndicator.querySelector('.pull-text').textContent = 'Đang làm mới...';
              pullIndicator.querySelector('.pull-icon').style.animation = 'spin 1s linear infinite';
              
              setTimeout(() => {
                // Simulate refresh - reload current chat
                if (currentChatId && chatHistories[currentChatId]) {
                  loadChat(currentChatId);
                }
                
                pullIndicator.style.transform = 'translateY(-80px)';
                setTimeout(() => {
                  pullIndicator.querySelector('.pull-icon').style.animation = '';
                  pullIndicator.querySelector('.pull-icon').style.transform = '';
                  pullIndicator.querySelector('.pull-text').textContent = 'Kéo để làm mới';
                }, 300);
              }, 1000);
            } else {
              pullIndicator.style.transform = 'translateY(-80px)';
            }
            
            isPulling = false;
            pullDistance = 0;
          });
        }

        // Enhanced Mobile Performance Optimizations
        function optimizeMobilePerformance() {
          // Optimize scrolling performance
          const scrollElements = [chatContainer, sidebar, document.querySelector('.chat-history')];
          scrollElements.forEach(element => {
            if (element) {
              element.style.willChange = 'scroll-position';
              element.style.transform = 'translateZ(0)'; // Force hardware acceleration
            }
          });

          // Optimize animations for mobile
          if (window.innerWidth <= 768) {
            document.documentElement.style.setProperty('--duration-75', '50ms');
            document.documentElement.style.setProperty('--duration-100', '75ms');
            document.documentElement.style.setProperty('--duration-150', '100ms');
            document.documentElement.style.setProperty('--duration-200', '150ms');
            document.documentElement.style.setProperty('--duration-300', '200ms');
          }

          // Debounce resize events
          let resizeTimeout;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              setViewportHeight();
              updateScrollIndicator();
            }, 100);
          });

          // Optimize touch events
          document.addEventListener('touchstart', () => {}, { passive: true });
          document.addEventListener('touchmove', () => {}, { passive: true });
          document.addEventListener('touchend', () => {}, { passive: true });
        }

        // Enhanced mobile input handling
        function enhanceMobileInput() {
          const userInput = document.getElementById('user-input');
          
          // Auto-resize textarea on mobile
          userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
          });

          // Handle mobile keyboard
          userInput.addEventListener('focus', () => {
            // Scroll to input on focus
            setTimeout(() => {
              userInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
          });

          // Prevent double-tap zoom
          let lastTouchEnd = 0;
          document.addEventListener('touchend', (event) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          }, false);
        }

        // Initialize mobile optimizations
        optimizeMobilePerformance();
        enhanceMobileInput();

        // Initialize pull-to-refresh on mobile
        if ('ontouchstart' in window) {
          handlePullToRefresh();
        }

        // Add scroll listener for micro-interactions
        chatContainer.addEventListener('scroll', updateScrollIndicator);
        
        // Add ripple effect to buttons
        document.addEventListener('click', function(e) {
          if (e.target.matches('button, .btn, [role="button"]')) {
            addRippleEffect(e.target, e);
          }
        });

        // Enhance all buttons with micro-interactions
        document.querySelectorAll('button, .btn, [role="button"]').forEach(enhanceButtonInteraction);

        // Enhanced Mobile Input Experience
        function setViewportHeight() {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        function handleVirtualKeyboard() {
          const userInput = document.getElementById('user-input');
          const chatContainer = document.querySelector('.chat-container');
          const chatInputArea = document.querySelector('.chat-input-area');
          
          let initialViewportHeight = window.innerHeight;
          let keyboardVisible = false;

          // Detect virtual keyboard
          function detectKeyboard() {
            const currentHeight = window.innerHeight;
            const heightDifference = initialViewportHeight - currentHeight;
            
            if (heightDifference > 150) { // Keyboard likely visible
              if (!keyboardVisible) {
                keyboardVisible = true;
                document.body.classList.add('keyboard-visible');
                
                // Adjust chat container height
                if (chatContainer) {
                  chatContainer.style.height = `calc(${currentHeight}px - 140px)`;
                }
                
                // Scroll to input
                setTimeout(() => {
                  if (chatInputArea) {
                    chatInputArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
                  }
                }, 100);
              }
            } else {
              if (keyboardVisible) {
                keyboardVisible = false;
                document.body.classList.remove('keyboard-visible');
                
                // Reset chat container height
                if (chatContainer) {
                  chatContainer.style.height = '';
                }
              }
            }
          }

          // Enhanced input focus handling
          userInput.addEventListener('focus', () => {
            setTimeout(detectKeyboard, 300);
            
            // Prevent zoom on iOS
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
              userInput.style.fontSize = '16px';
            }
          });

          userInput.addEventListener('blur', () => {
            setTimeout(detectKeyboard, 300);
            
            // Reset font size
            userInput.style.fontSize = '';
          });

          // Handle resize events
          window.addEventListener('resize', () => {
            setTimeout(detectKeyboard, 100);
          });

          // Handle orientation change
          window.addEventListener('orientationchange', () => {
            setTimeout(() => {
              initialViewportHeight = window.innerHeight;
              setViewportHeight();
              detectKeyboard();
            }, 500);
          });
        }

        setViewportHeight();
        handleVirtualKeyboard();
        window.addEventListener('resize', setViewportHeight);

        // --- Xử lý Chat ---
        chatForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const userMessage = userInput.value.trim();
          if (!userMessage || sendBtn.disabled) return;

          // Add loading state to send button
          sendBtn.classList.add('loading');
          sendBtn.disabled = true;

          addMessage(userMessage, "user");
          userInput.value = "";
          userInput.style.height = "auto";
          
          // Update character counter
          if (charCounter) {
            charCounter.textContent = "0";
            document.querySelector('.char-counter').classList.remove('warning', 'error');
          }
          
          addTypingIndicator();

          // Update UI for generation state
          isGenerating = true;
          updateGenerationUI(true);

          try {
            // Create abort controller for stopping generation
            abortController = new AbortController();
            updateConnectionStatus("connecting");

            // !!! THAY THẾ BẰNG API KEY CỦA BẠN !!!
            const apiKey = "AIzaSyBoNRF6BCG8jeLme6wMwSZLPy9j0In05HM";
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [
                        {
                          text: userMessage,
                        },
                      ],
                    },
                  ],
                }),
                signal: abortController.signal,
              }
            );

            removeTypingIndicator();
            updateConnectionStatus("online");

            if (!response.ok) {
              const errorData = await response.json();
              const lang = "lo"; // Always use Lao
              throw new Error(
                errorData.error.message || languageStrings[lang].errorMessage
              );
            }

            const data = await response.json();
            const botMessage = data.candidates[0].content.parts[0].text;
            addMessage(botMessage, "bot");
            saveMessageToHistory(botMessage, "bot"); // Lưu tin nhắn bot vào lịch sử
          } catch (error) {
            removeTypingIndicator();
            updateConnectionStatus("online");

            if (error.name === "AbortError") {
              addMessage("ການສ້າງຄໍາຕອບຖືກຢຸດແລ້ວ", "bot");
            } else {
              console.error("Lỗi khi gọi API Gemini:", error);
              const lang = "lo"; // Always use Lao
              addMessage(
                `${languageStrings[lang].errorMessage} ${error.message}`,
                "bot"
              );
            }
          } finally {
            isGenerating = false;
            updateGenerationUI(false);
            abortController = null;
            
            // Remove loading state from send button
            sendBtn.classList.remove('loading');
            sendBtn.disabled = userInput.value.trim().length === 0;
          }
        });

        function addMessage(message, sender, saveToHistory = true) {
          // Remove placeholder if it exists
          const placeholder = document.querySelector(".welcome-placeholder");
          if (placeholder) {
            placeholder.remove();
          }

          const messageElement = document.createElement("div");
          messageElement.classList.add("message", sender, "new-message");

          const icon = document.createElement("div");
          icon.classList.add("icon");
          const iconSpan = document.createElement("span");
          iconSpan.classList.add("material-symbols-outlined");
          iconSpan.textContent =
            sender === "user" ? "account_circle" : "smart_toy";
          icon.appendChild(iconSpan);

          const textElement = document.createElement("div");
          textElement.classList.add("text");

          const formattedMessage = message
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") // Bold
            .replace(/\*(.*?)\*/g, "<em>$1</em>") // Italics
            .replace(/\n/g, "<br>"); // New lines
          textElement.innerHTML = `<div class="message-text">${formattedMessage}</div>`;

          // Add message meta information
          const metaElement = document.createElement("div");
          metaElement.classList.add("message-meta");
          
          const timestamp = new Date().toLocaleTimeString('lo-LA', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          });
          
          const timestampElement = document.createElement("div");
          timestampElement.classList.add("message-timestamp");
          timestampElement.innerHTML = `<span class="material-symbols-outlined" style="font-size: 12px;">schedule</span>${timestamp}`;
          
          // Add status for user messages
          if (sender === "user") {
            const statusElement = document.createElement("div");
            statusElement.classList.add("message-status", "sent");
            statusElement.innerHTML = `<div class="status-icon">✓</div>ສົ່ງແລ້ວ`;
            metaElement.appendChild(statusElement);
          }
          
          metaElement.appendChild(timestampElement);
          textElement.appendChild(metaElement);

          messageElement.appendChild(icon);
          messageElement.appendChild(textElement);

          // Add message actions
          createMessageActions(messageElement, message, sender);

          chatContainer.appendChild(messageElement);
          
          // Remove new-message class after animation completes
          setTimeout(() => {
            messageElement.classList.remove("new-message");
          }, 400);
          
          // Enhanced smooth scroll to bottom with scroll indicator
          setTimeout(() => {
            chatContainer.scrollTo({
              top: chatContainer.scrollHeight,
              behavior: 'smooth'
            });
            
            // Update scroll indicator
            updateScrollIndicator();
          }, 100);

          if (saveToHistory) {
            saveMessageToHistory(message, sender);
          }
        }

        function addTypingIndicator() {
          const typingIndicator = document.createElement("div");
          typingIndicator.classList.add("message", "bot", "typing-indicator");
          typingIndicator.innerHTML = `
            <div class="icon">
                <span class="material-symbols-outlined">smart_toy</span>
            </div>
            <div class="text">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
          chatContainer.appendChild(typingIndicator);
          
          // Scroll to typing indicator
          setTimeout(() => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }, 50);
        }

        function removeTypingIndicator() {
          const typingIndicator = document.querySelector(".typing-indicator");
          if (typingIndicator) {
            // Add exit animation
            typingIndicator.style.animation = 'typingIndicatorExit 0.3s ease-out forwards';
            setTimeout(() => {
              if (typingIndicator.parentNode) {
                typingIndicator.remove();
              }
            }, 300);
          }
        }

        // Add exit animation keyframes
        const exitAnimationStyle = document.createElement('style');
        exitAnimationStyle.textContent = `
          @keyframes typingIndicatorExit {
            from {
              opacity: 1;
              transform: translateY(0) scale(1);
            }
            to {
              opacity: 0;
              transform: translateY(-10px) scale(0.95);
            }
          }
        `;
        document.head.appendChild(exitAnimationStyle);

        // Enhanced Micro-interaction Functions
        function updateScrollIndicator() {
          const scrollTop = chatContainer.scrollTop;
          const scrollHeight = chatContainer.scrollHeight;
          const clientHeight = chatContainer.clientHeight;
          
          if (scrollTop > 50) {
            chatContainer.classList.add('scrolled');
          } else {
            chatContainer.classList.remove('scrolled');
          }
        }

        function addMessageStateAnimation(messageElement, state) {
          // Remove existing state classes
          messageElement.classList.remove('editing', 'deleting', 'sending');
          
          if (state) {
            messageElement.classList.add(state);
          }
        }

        function enhanceButtonInteraction(button) {
          button.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = 'var(--shadow-lg)';
          });
          
          button.addEventListener('mouseleave', function() {
            this.style.transform = '';
            this.style.boxShadow = '';
          });
          
          button.addEventListener('mousedown', function() {
            this.style.transform = 'translateY(0) scale(0.98)';
          });
          
          button.addEventListener('mouseup', function() {
            this.style.transform = 'translateY(-2px)';
          });
        }

        function addRippleEffect(element, event) {
          const rect = element.getBoundingClientRect();
          const size = Math.max(rect.width, rect.height);
          const x = event.clientX - rect.left - size / 2;
          const y = event.clientY - rect.top - size / 2;
          
          const ripple = document.createElement('div');
          ripple.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            left: ${x}px;
            top: ${y}px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
          `;
          
          element.appendChild(ripple);
          
          setTimeout(() => {
            ripple.remove();
          }, 600);
        }

        function smoothScrollToMessage(messageElement) {
          messageElement.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
            inline: 'nearest'
          });
          
          // Highlight the message briefly
          messageElement.style.backgroundColor = 'rgba(16, 163, 127, 0.1)';
          setTimeout(() => {
            messageElement.style.backgroundColor = '';
          }, 1000);
        }

        function addWelcomePlaceholder(lang) {
          const suggestions = {
            lo: [
              {
                title: "ຖາມກ່ຽວກັບພາສາລາວ",
                desc: "ຮຽນຮູ້ກ່ຽວກັບວັດທະນະທໍາ ແລະ ປະເພນີລາວ",
              },
              { title: "ຊ່ວຍແປພາສາ", desc: "ແປຂໍ້ຄວາມຈາກພາສາອື່ນເປັນພາສາລາວ" },
              {
                title: "ຄໍາແນະນໍາການຮຽນ",
                desc: "ຮຽນຮູ້ສິ່ງໃໝ່ໆ ແລະ ພັດທະນາທັກສະ",
              },
              { title: "ສົນທະນາທົ່ວໄປ", desc: "ສົນທະນາກ່ຽວກັບຫົວຂໍ້ທີ່ສົນໃຈ" },
            ],
            vi: [
              {
                title: "Hỏi về văn hóa Lào",
                desc: "Tìm hiểu về truyền thống và văn hóa Lào",
              },
              {
                title: "Hỗ trợ dịch thuật",
                desc: "Dịch văn bản sang tiếng Lào hoặc ngược lại",
              },
              {
                title: "Tư vấn học tập",
                desc: "Học hỏi kiến thức mới và phát triển kỹ năng",
              },
              {
                title: "Trò chuyện tự do",
                desc: "Thảo luận về các chủ đề bạn quan tâm",
              },
            ],
            en: [
              {
                title: "Learn about Lao culture",
                desc: "Discover traditions and customs of Laos",
              },
              {
                title: "Translation help",
                desc: "Translate text to/from Lao language",
              },
              {
                title: "Study guidance",
                desc: "Learn new things and develop skills",
              },
              {
                title: "General chat",
                desc: "Discuss topics you're interested in",
              },
            ],
          };

          chatContainer.innerHTML = `
                <div class="welcome-screen">
                    <div class="welcome-icon">
                        <span class="material-symbols-outlined">smart_toy</span>
                    </div>
                    <h1 class="welcome-title">${
                      languageStrings[lang].welcomeMessage
                    }</h1>
                    <p class="welcome-subtitle">ເລືອກຫົວຂໍ້ຂ້າງລຸ່ມນີ້ ຫຼື ພິມຄໍາຖາມຂອງທ່ານ</p>
                    <div class="suggestion-cards">
                        ${suggestions[lang]
                          .map(
                            (suggestion) => `
                            <div class="suggestion-card" onclick="handleSuggestionClick('${suggestion.title}')">
                                <h4>${suggestion.title}</h4>
                                <p>${suggestion.desc}</p>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;
        }

        function handleSuggestionClick(suggestion) {
          userInput.value = suggestion;
          chatForm.dispatchEvent(new Event("submit"));
        }

        // Export functionality
        function editMessage(messageElement, originalMessage) {
          const textElement = messageElement.querySelector(".message-text");
          const currentText = textElement.textContent;

          const input = document.createElement("textarea");
          input.value = currentText;
          input.className = "edit-input";
          input.style.cssText = `
            width: 100%;
            min-height: 60px;
            padding: 12px;
            border: 2px solid var(--primary-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: inherit;
            background: var(--background-color);
            color: var(--text-color);
            resize: vertical;
          `;

          const saveBtn = document.createElement("button");
          saveBtn.textContent = "ບັນທຶກ";
          saveBtn.style.cssText = `
            margin-top: 8px;
            margin-right: 8px;
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
          `;

          const cancelBtn = document.createElement("button");
          cancelBtn.textContent = "ຍົກເລີກ";
          cancelBtn.style.cssText = `
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
          `;

          textElement.innerHTML = "";
          textElement.appendChild(input);
          textElement.appendChild(saveBtn);
          textElement.appendChild(cancelBtn);

          input.focus();

          saveBtn.addEventListener("click", () => {
            const newText = input.value.trim();
            if (newText) {
              textElement.innerHTML = `<div class="message-text">${newText}</div>`;
              // Update in chat history
              updateMessageInHistory(originalMessage, newText);
            }
          });

          cancelBtn.addEventListener("click", () => {
            textElement.innerHTML = `<div class="message-text">${currentText}</div>`;
          });
        }

        function deleteMessage(messageElement) {
          if (confirm("ທ່ານຕ້ອງການລຶບຂໍ້ຄວາມນີ້ບໍ?")) {
            messageElement.style.animation = "fadeOut 0.3s ease";
            setTimeout(() => {
              messageElement.remove();
            }, 300);
          }
        }

        function updateMessageInHistory(originalMessage, newMessage) {
          if (chatHistories[currentChatId]) {
            const messageIndex = chatHistories[currentChatId].findIndex(
              (msg) => msg.message === originalMessage
            );
            if (messageIndex !== -1) {
              chatHistories[currentChatId][messageIndex].message = newMessage;
              localStorage.setItem(
                "chatHistories",
                JSON.stringify(chatHistories)
              );
            }
          }
        }

        function updateGenerationUI(generating) {
          const submitBtn = chatForm.querySelector('button[type="submit"]');
          const submitIcon = submitBtn.querySelector(
            ".material-symbols-outlined"
          );

          if (generating) {
            submitIcon.textContent = "stop";
            submitBtn.title = "ຢຸດການສ້າງ";
            submitBtn.style.background = "var(--error-color)";
          } else {
            submitIcon.textContent = "send";
            submitBtn.title = "ສົ່ງ";
            submitBtn.style.background = "var(--primary-color)";
          }
        }

        // Community Templates Data
        const communityTemplates = [
          // Learning Category
          {
            id: 1,
            title: "ການຮຽນພາສາລາວ",
            category: "learning",
            description: "ແມ່ແບບສໍາລັບການຮຽນຮູ້ພາສາລາວຂັ້ນພື້ນຖານ",
            content:
              "ຂ້ອຍຕ້ອງການຮຽນພາສາລາວ. ກະລຸນາແນະນໍາວິທີການຮຽນທີ່ດີທີ່ສຸດ ແລະ ແຫຼ່ງຮຽນຮູ້ທີ່ເໝາະສົມ",
            rating: 4.8,
            usage: 125,
            author: "ຄູສອນພາສາ",
          },
          {
            id: 2,
            title: "ອະທິບາຍແນວຄິດຊັບຊ້ອນ",
            category: "learning",
            description: "ຂໍໃຫ້ອະທິບາຍເລື່ອງຍາກໃຫ້ງ່າຍຂຶ້ນ",
            content:
              "ກະລຸນາອະທິບາຍແນວຄິດນີ້ໃຫ້ຂ້ອຍຟັງແບບງ່າຍໆ ຄືກັບອະທິບາຍໃຫ້ເດັກນ້ອຍຟັງ:",
            rating: 4.7,
            usage: 98,
            author: "ຄູສອນ",
          },
          {
            id: 3,
            title: "ສ້າງແຜນການຮຽນ",
            category: "learning",
            description: "ສ້າງແຜນການຮຽນສະເພາະບຸກຄົນ",
            content:
              "ຊ່ວຍສ້າງແຜນການຮຽນ 30 ວັນສໍາລັບ [ຫົວຂໍ້] ໂດຍແບ່ງເປັນຂັ້ນຕອນທີ່ຊັດເຈນ",
            rating: 4.9,
            usage: 156,
            author: "ນັກການສຶກສາ",
          },

          // Business Category
          {
            id: 4,
            title: "ຈົດໝາຍທຸລະກິດ",
            category: "business",
            description: "ແມ່ແບບສໍາລັບການຂຽນຈົດໝາຍທຸລະກິດເປັນພາສາລາວ",
            content:
              "ຊ່ວຍຂຽນຈົດໝາຍທຸລະກິດເປັນພາສາລາວທີ່ສຸພາບແລະເປັນທາງການກ່ຽວກັບ [ຫົວຂໍ້]",
            rating: 4.6,
            usage: 89,
            author: "ນັກທຸລະກິດ",
          },
          {
            id: 5,
            title: "ແຜນທຸລະກິດ",
            category: "business",
            description: "ສ້າງແຜນທຸລະກິດສໍາລັບ startup",
            content:
              "ຊ່ວຍສ້າງແຜນທຸລະກິດສໍາລັບ [ປະເພດທຸລະກິດ] ໃນປະເທດລາວ ລວມທັງການວິເຄາະຕະຫຼາດ ແລະ ຍຸດທະສາດ",
            rating: 4.8,
            usage: 134,
            author: "ທີ່ປຶກສາທຸລະກິດ",
          },
          {
            id: 6,
            title: "ການນໍາສະເໜີ",
            category: "business",
            description: "ສ້າງເນື້ອຫາການນໍາສະເໜີທີ່ໜ້າສົນໃຈ",
            content:
              "ຊ່ວຍສ້າງໂຄງຮ່າງການນໍາສະເໜີ PowerPoint ກ່ຽວກັບ [ຫົວຂໍ້] ທີ່ໜ້າສົນໃຈແລະມີປະສິດທິພາບ",
            rating: 4.5,
            usage: 76,
            author: "ຜູ້ຊ່ຽວຊານ",
          },

          // Creative Category
          {
            id: 7,
            title: "ການຂຽນເລື່ອງສັ້ນ",
            category: "creative",
            description: "ແມ່ແບບສໍາລັບການຂຽນເລື່ອງສັ້ນເປັນພາສາລາວ",
            content:
              "ຊ່ວຍຂຽນເລື່ອງສັ້ນເປັນພາສາລາວກ່ຽວກັບ [ຫົວຂໍ້] ທີ່ມີຄວາມໝາຍເລິກຊຶ້ງແລະສະທ້ອນວັດທະນະທໍາລາວ",
            rating: 4.7,
            usage: 43,
            author: "ນັກຂຽນ",
          },
          {
            id: 8,
            title: "ບົດກະວີລາວ",
            category: "creative",
            description: "ສ້າງບົດກະວີແບບລາວດັ້ງເດີມ",
            content:
              "ຊ່ວຍແຕ່ງບົດກະວີລາວແບບດັ້ງເດີມກ່ຽວກັບ [ຫົວຂໍ້] ດ້ວຍຄໍາສັບທີເໝາະສົມກັບວັດທະນະທໍາລາວ",
            rating: 4.9,
            usage: 67,
            author: "ກະວີ",
          },
          {
            id: 9,
            title: "ສ້າງຕົວລະຄອນ",
            category: "creative",
            description: "ພັດທະນາຕົວລະຄອນສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດ",
            content:
              "ຊ່ວຍສ້າງຕົວລະຄອນທີ່ມີມິຕິຊັບຊ້ອນສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດ",
            rating: 4.6,
            usage: 52,
            author: "ນັກຂຽນນິຍາຍ",
          },

          // Translation Category
          {
            id: 10,
            title: "ການແປເອກະສານ",
            category: "translation",
            description: "ແມ່ແບບສໍາລັບການແປເອກະສານຈາກພາສາອື່ນເປັນພາສາລາວ",
            content:
              "ກະລຸນາແປເອກະສານນີ້ເປັນພາສາລາວໂດຍຮັກສາຄວາມໝາຍເດີມ ແລະ ໃຊ້ຄໍາສັບທີເໝາະສົມກັບວັດທະນະທໍາລາວ:",
            rating: 4.9,
            usage: 67,
            author: "ນັກແປ",
          },
          {
            id: 11,
            title: "ແປສໍານວນ",
            category: "translation",
            description: "ແປສໍານວນແລະຄໍາເວົ້າມີຄວາມໝາຍ",
            content:
              "ຊ່ວຍແປສໍານວນ/ຄໍາເວົ້າ '[ຂໍ້ຄວາມ]' ຀ປັນພາສາລາວ ແລະ ອະທິບາຍຄວາມໝາຍເລິກຊຶ້ງ",
            rating: 4.8,
            usage: 89,
            author: "ຜູ້ຊ່ຽວຊານພາສາ",
          },
          {
            id: 12,
            title: "ແປເນື້ອເພງ",
            category: "translation",
            description: "ແປເນື້ອເພງໃຫ້ມີຈັງຫວະ",
            content:
              "ແປເນື້ອເພງນີ້ເປັນພາສາລາວໂດຍຮັກສາຈັງຫວະ ແລະ ຄວາມໝາຍ ໃຫ້ຟັງແລ້ວໄພເລາະ:",
            rating: 4.7,
            usage: 45,
            author: "ນັກແປເພງ",
          },

          // Coding Category
          {
            id: 13,
            title: "ອະທິບາຍ Code",
            category: "coding",
            description: "ອະທິບາຍ code ໃຫ້ເຂົ້າໃຈງ່າຍ",
            content:
              "ກະລຸນາອະທິບາຍ code ນີ້ເປັນພາສາລາວວ່າມັນເຮັດຫຍັງ ແລະ ເຮັດວຽກແນວໃດ:",
            rating: 4.8,
            usage: 112,
            author: "ນັກພັດທະນາ",
          },
          {
            id: 14,
            title: "ແກ້ບັນຫາ Bug",
            category: "coding",
            description: "ຊ່ວຍຊອກຫາແລະແກ້ໄຂບັນຫາໃນ code",
            content:
              "ຂໍໃຫ້ອະທິບາຍບັນຫາໃນ code ນີ້: [code] ຊ່ວຍຊອກຫາບັນຫາແລະແນະນໍາວິທີແກ້ໄຂ",
            rating: 4.9,
            usage: 156,
            author: "Senior Developer",
          },
          {
            id: 15,
            title: "ສ້າງ Function",
            category: "coding",
            description: "ສ້າງ function ຕາມຄວາມຕ້ອງການ",
            content:
              "ຊ່ວຍຂຽນ function ໃນ [ພາສາ programming] ທີ່ [ຄໍາອະທິບາຍຄວາມຕ້ອງການ] ພ້ອມ comment ອະທິບາຍ",
            rating: 4.7,
            usage: 98,
            author: "Code Mentor",
          },

          // Daily Life Category
          {
            id: 16,
            title: "ແຜນອາຫານ",
            category: "daily",
            description: "ສ້າງແຜນອາຫານສຸຂະພາບດີ",
            content:
              "ຊ່ວຍສ້າງແຜນອາຫານ 7 ວັນທີ່ມີປະໂຫຍດຕໍ່ສຸຂະພາບ ໃຊ້ວັດຖຸດິບທີ່ຫາງ່າຍໃນລາວ",
            rating: 4.6,
            usage: 134,
            author: "ນັກໂພຊະນາການ",
          },
          {
            id: 17,
            title: "ຄໍາແນະນໍາການເດີນທາງ",
            category: "daily",
            description: "ວາງແຜນການເດີນທາງໃນລາວ",
            content:
              "ຊ່ວຍວາງແຜນການເດີນທາງ [ຈໍານວນວັນ] ວັນໃນ [ສະຖານທີ່] ລວມທັງສະຖານທີ່ທ່ອງທ່ຽວ ອາຫານ ແລະ ທີ່ພັກ",
            rating: 4.8,
            usage: 167,
            author: "ມັກຄະເທດ",
          },
          {
            id: 18,
            title: "ການຈັດການເວລາ",
            category: "daily",
            description: "ສ້າງຕາຕະລາງວຽກມີປະສິດທິພາບ",
            content:
              "ຊ່ວຍສ້າງຕາຕະລາງວຽກປະຈໍາວັນທີ່ມີປະສິດທິພາບສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດສໍາລັດ",
            rating: 4.7,
            usage: 89,
            author: "ຜູ້ຊ່ຽວຊານ",
          },

          // Health & Wellness Category
          {
            id: 19,
            title: "ແຜນອອກກໍາລັງກາຍ",
            category: "health",
            description: "ສ້າງແຜນອອກກໍາລັງກາຍສ່ວນບຸກຄົນ",
            content:
              "ສ້າງແຜນອອກກໍາລັງກາຍ [ຈໍານວນ] ອາທິດສໍາລັບ [ເປົ້າໝາຍ] ທີ່ເໝາະກັບຄົນເລີ່ມຕົ້ນ",
            rating: 4.8,
            usage: 123,
            author: "ຄູຝຶກ",
          },
          {
            id: 20,
            title: "ການຈັດການຄວາມເຄັ່ງຕຶງ",
            category: "health",
            description: "ເທັກນິກຜ່ອນຄາຍແລະສະມາທິ",
            content:
              "ແນະນໍາເທັກນິກການຜ່ອນຄາຍແລະຈັດການຄວາມເຄັ່ງຕຶງທີ່ເໝາະກັບວິຖີຊີວິດລາວ",
            rating: 4.9,
            usage: 145,
            author: "ນັກຈິດຕະວິທະຍາ",
          },

          // Education Category
          {
            id: 21,
            title: "ສ້າງແບບທົດສອບ",
            category: "education",
            description: "ສ້າງຄໍາຖາມທົດສອບຄວາມຮູ້",
            content:
              "ສ້າງແບບທົດສອບ [ຈໍານວນ] ຂໍ້ກ່ຽວກັບ [ຫົວຂໍ້] ແບບຫຼາກຫຼາຍຮູບແບບ ພ້ອມເຉລຍ",
            rating: 4.7,
            usage: 98,
            author: "ຄູສອນ",
          },
          {
            id: 22,
            title: "ອະທິບາຍສໍາລັບເດັກ",
            category: "education",
            description: "ອະທິບາຍເລື່ອງຍາກໃຫ້ເດັກເຂົ້າໃຈ",
            content:
              "ອະທິບາຍ [ຫົວຂໍ້] ຃ອງເດັກອາຍຸ [ອາຍຸ] ປີເຂົ້າໃຈ ດ້ວຍຄໍາງ່າຍໆ ແລະຕົວຢ່າງທີ່ສົນໃຈ",
            rating: 4.8,
            usage: 156,
            author: "ຄູອະນຸບານ",
          },
        ];









        // Advanced Template Management System
        class TemplateManager {
          constructor() {
            this.templates = [...communityTemplates];
            this.favorites = JSON.parse(
              localStorage.getItem("favoriteTemplates") || "[]"
            );
            this.userTemplates = JSON.parse(
              localStorage.getItem("userTemplates") || "[]"
            );
            this.templateStats = JSON.parse(
              localStorage.getItem("templateStats") || "{}"
            );
          }

          addToFavorites(templateId) {
            if (!this.favorites.includes(templateId)) {
              this.favorites.push(templateId);
              this.saveFavorites();
              this.updateTemplateStats(templateId, "favorited");
            }
          }

          removeFromFavorites(templateId) {
            this.favorites = this.favorites.filter((id) => id !== templateId);
            this.saveFavorites();
          }

          saveFavorites() {
            localStorage.setItem(
              "favoriteTemplates",
              JSON.stringify(this.favorites)
            );
          }

          createUserTemplate(template) {
            const newTemplate = {
              ...template,
              id: Date.now(),
              author: "ທ່ານ",
              isUserTemplate: true,
              createdAt: new Date().toISOString(),
              rating: 0,
              usage: 0,
            };
            this.userTemplates.push(newTemplate);
            this.saveUserTemplates();
            return newTemplate;
          }

          saveUserTemplates() {
            localStorage.setItem(
              "userTemplates",
              JSON.stringify(this.userTemplates)
            );
          }

          updateTemplateStats(templateId, action) {
            if (!this.templateStats[templateId]) {
              this.templateStats[templateId] = {
                views: 0,
                uses: 0,
                favorites: 0,
              };
            }

            switch (action) {
              case "viewed":
                this.templateStats[templateId].views++;
                break;
              case "used":
                this.templateStats[templateId].uses++;
                break;
              case "favorited":
                this.templateStats[templateId].favorites++;
                break;
            }

            localStorage.setItem(
              "templateStats",
              JSON.stringify(this.templateStats)
            );
          }

          getTemplateStats(templateId) {
            return (
              this.templateStats[templateId] || {
                views: 0,
                uses: 0,
                favorites: 0,
              }
            );
          }

          getAllTemplates() {
            return [...this.templates, ...this.userTemplates];
          }

          exportTemplates() {
            const exportData = {
              userTemplates: this.userTemplates,
              favorites: this.favorites,
              stats: this.templateStats,
              exportDate: new Date().toISOString(),
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `lao-chat-templates-${
              new Date().toISOString().split("T")[0]
            }.json`;
            a.click();
            URL.revokeObjectURL(url);
          }

          importTemplates(file) {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const data = JSON.parse(e.target.result);
                  if (data.userTemplates) {
                    this.userTemplates = [
                      ...this.userTemplates,
                      ...data.userTemplates,
                    ];
                    this.saveUserTemplates();
                  }
                  if (data.favorites) {
                    this.favorites = [
                      ...new Set([...this.favorites, ...data.favorites]),
                    ];
                    this.saveFavorites();
                  }
                  if (data.stats) {
                    this.templateStats = data.stats;
                    localStorage.setItem("templateStats", JSON.stringify(data.stats));
                  }

                  resolve(data);
                } catch (error) {
                  reject(error);
                }
              };
              reader.readAsText(file);
            });
          }
        }

        // Initialize Template Manager
        const templateManager = new TemplateManager();

        // Enhanced Community Templates Modal with Advanced Features
        function showCommunityTemplatesAdvanced() {
          const modal = document.createElement("div");
          modal.className = "modal";
          modal.style.display = "flex";

          const categoryIcons = {
            learning: "📚",
            business: "💼",
            creative: "🎨",
            translation: "🌐",
            coding: "💻",
            "daily-life": "🏠",
            health: "🏥",
            education: "🎓",
            favorites: "⭐",
            "my-templates": "👤",
          };

          modal.innerHTML = `
            <div class="modal-content" style="max-width: 1000px; width: 95%; max-height: 90vh; overflow: hidden;">
              <span class="close-btn">&times;</span>
              <div class="template-modal-header">
                <h2 style="margin-bottom: 20px; color: var(--text-color);">
                  🌟 ແມ່ແບບຊຸມຊົນ - Community Templates
                </h2>
                
                <!-- Advanced Controls -->
                <div class="template-controls" style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                  <div class="search-container" style="flex: 1; min-width: 250px;">
                    <input type="text" id="template-search-advanced" placeholder="🔍 ຄົ້ນຫາແມ່ແບບ..." 
                           style="width: 100%; padding: 10px 16px; border: 2px solid var(--border-color); border-radius: 25px; font-size: 14px;">
                  </div>
                  
                  <select id="sort-templates" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
                    <option value="newest">ໃໝ່ທີ່ສຸດ</option>
                    <option value="popular">ນິຍົມທີ່ສຸດ</option>
                    <option value="rating">ຄະແນນສູງສຸດ</option>
                    <option value="alphabetical">ຕາມໂຕອັກສອນ</option>
                  </select>
                  
                  <button id="create-template-btn" style="padding: 10px 16px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ➕ ສ້າງແມ່ແບບ
                  </button>
                  
                  <button id="import-templates-btn" style="padding: 10px 16px; background: var(--info-color); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    📥 ນຳເຂົ້າ
                  </button>
                  
                  <button id="export-templates-btn" style="padding: 10px 16px; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    📤 ສົ່ງອອກ
                  </button>
                </div>
              </div>

              <div class="template-modal-body" style="display: flex; height: calc(90vh - 200px);">
                <!-- Sidebar Categories -->
                <div class="template-sidebar" style="width: 200px; border-right: 1px solid var(--border-color); padding-right: 16px; overflow-y: auto;">
                  <div class="template-categories">
                    <div class="category-item active" data-category="all" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                      🌟 ທັງໝົດ
                    </div>
                    <div class="category-item" data-category="favorites" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                      ⭐ ລາຍການທີ່ຊອບ
                    </div>
                    <div class="category-item" data-category="my-templates" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                      👤 ແມ່ແບບຂອງຂ້ອຍ
                    </div>
                    <hr style="margin: 12px 0; border: none; border-top: 1px solid var(--border-color);">
                    ${Object.keys(categoryIcons)
                      .filter(
                        (cat) => !["favorites", "my-templates"].includes(cat)
                      )
                      .map(
                        (category) => `
                      <div class="category-item" data-category="${category}" style="padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                        ${categoryIcons[category]} ${getCategoryName(category)}
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>

                <!-- Templates Grid -->
                <div class="templates-content" style="flex: 1; padding-left: 16px; overflow-y: auto;">
                  <div id="templates-grid-advanced" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                    <!-- Templates will be populated here -->
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // Enhanced template rendering with stats and actions
          function renderTemplatesAdvanced(templates, category = "all") {
            const grid = document.getElementById("templates-grid-advanced");
            const filteredTemplates = filterTemplatesByCategory(
              templates,
              category
            );

            grid.innerHTML = filteredTemplates
              .map((template) => {
                const stats = templateManager.getTemplateStats(template.id);
                const isFavorite = templateManager.favorites.includes(
                  template.id
                );
                const isUserTemplate = template.isUserTemplate;

                return `
                <div class="template-card-advanced" data-template-id="${
                  template.id
                }" 
                     style="background: var(--bot-message-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                  
                  <!-- Template Header -->
                  <div class="template-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div class="template-category-badge" style="background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;">
                      ${
                        categoryIcons[template.category] || "📝"
                      } ${getCategoryName(template.category)}
                    </div>
                    
                    <div class="template-actions" style="display: flex; gap: 4px;">
                      <button class="favorite-btn ${
                        isFavorite ? "active" : ""
                      }" data-template-id="${template.id}" 
                              style="background: none; border: none; cursor: pointer; font-size: 1.2rem; color: ${
                                isFavorite ? "#f59e0b" : "#ccc"
                              };">
                        ${isFavorite ? "⭐" : "☆"}
                      </button>
                      ${
                        isUserTemplate
                          ? `
                        <button class="edit-template-btn" data-template-id="${template.id}" 
                                style="background: none; border: none; cursor: pointer; font-size: 1rem; color: var(--text-secondary);">
                          ✏️
                        </button>
                        <button class="delete-template-btn" data-template-id="${template.id}" 
                                style="background: none; border: none; cursor: pointer; font-size: 1rem; color: var(--error-color);">
                          🗑️
                        </button>
                      `
                          : ""
                      }
                    </div>
                  </div>

                  <!-- Template Content -->
                  <h4 style="font-size: 1rem; font-weight: 600; color: var(--text-color); margin-bottom: 8px;">
                    ${template.title}
                  </h4>
                  
                  <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                    ${template.description}
                  </p>

                  <!-- Template Preview -->
                  <div class="template-preview" style="background: var(--secondary-color); padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 0.8rem; color: var(--text-secondary); max-height: 60px; overflow: hidden;">
                    ${template.content.substring(0, 100)}${
                  template.content.length > 100 ? "..." : ""
                }
                  </div>

                  <!-- Template Stats -->
                  <div class="template-stats" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-secondary);">
                    <div class="stats-left" style="display: flex; gap: 12px;">
                      <span>👁️ ${stats.views}</span>
                      <span>🔥 ${stats.uses}</span>
                      <span>⭐ ${stats.favorites}</span>
                    </div>
                    
                    <div class="stats-right" style="display: flex; align-items: center; gap: 8px;">
                      <div class="rating" style="display: flex; align-items: center; gap: 2px;">
                        ${"★".repeat(Math.floor(template.rating))}${"☆".repeat(
                  5 - Math.floor(template.rating)
                )}
                        <span style="margin-left: 4px;">${
                          template.rating
                        }</span>
                      </div>
                      <span style="color: var(--text-secondary);">• ${
                        template.author
                      }</span>
                    </div>
                  </div>

                  <!-- Hover Actions -->
                  <div class="template-hover-actions" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.2s ease; background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem;">
                    ຄລິກເພື່ອໃຊ້ງານ
                  </div>
                </div>
              `;
              })
              .join("");

            // Add hover effects
           
            document
              .querySelectorAll(".template-card-advanced")
              .forEach((card) => {
                const hoverActions = card.querySelector(
                  ".template-hover-actions"
                );

                card.addEventListener("mouseenter", () => {
                  card.style.transform = "translateY(-4px)";
                  card.style.boxShadow = "var(--shadow-medium)";
                  hoverActions.style.opacity = "1";
                });

                card.addEventListener("mouseleave", () => {
                  card.style.transform = "translateY(0)";
                  card.style.boxShadow = "none";
                  hoverActions.style.opacity = "0";
                });
              });
          }

          function filterTemplatesByCategory(templates, category) {
            if (category === "all") return templates;
            if (category === "favorites") {
              return templates.filter((t) =>
                templateManager.favorites.includes(t.id)
              );
            }
            if (category === "my-templates") {
              return templateManager.userTemplates;
            }
            return templates.filter((t) => t.category === category);
          }

          // Initial render
          renderTemplatesAdvanced(templateManager.getAllTemplates());

          // Category filtering
          document.querySelectorAll(".category-item").forEach((item) => {
            item.addEventListener("click", () => {
              document
                .querySelectorAll(".category-item")
                .forEach((i) => i.classList.remove("active"));
              item.classList.add("active");
              item.style.background = "var(--primary-color)";
              item.style.color = "white";

              const category = item.dataset.category;
              renderTemplatesAdvanced(
                templateManager.getAllTemplates(),
                category
              );
            });
          });

          // Search functionality
          document
            .getElementById("template-search-advanced")
            .addEventListener("input", (e) => {
              const searchTerm = e.target.value.toLowerCase();
              const activeCategory = document.querySelector(
                ".category-item.active"
              ).dataset.category;
              let templates = templateManager.getAllTemplates();

              if (searchTerm) {
                templates = templates.filter(
                  (t) =>
                    t.title.toLowerCase().includes(searchTerm) ||
                    t.description.toLowerCase().includes(searchTerm) ||
                    t.content.toLowerCase().includes(searchTerm)
                );
              }

              renderTemplatesAdvanced(templates, activeCategory);
            });

          // Sort functionality
          document
            .getElementById("sort-templates")
            .addEventListener("change", (e) => {
              const sortBy = e.target.value;
              let templates = [...templateManager.getAllTemplates()];

              switch (sortBy) {
                case "newest":
                  templates.sort(
                    (a, b) => (b.createdAt || b.id) - (a.createdAt || a.id)
                  );
                  break;
                case "popular":
                  templates.sort((a, b) => {
                    const statsA = templateManager.getTemplateStats(a.id);
                    const statsB = templateManager.getTemplateStats(b.id);
                    return (
                      statsB.uses +
                      statsB.favorites -
                      (statsA.uses + statsA.favorites)
                    );
                  });
                  break;
                case "rating":
                  templates.sort((a, b) => b.rating - a.rating);
                  break;
                case "alphabetical":
                  templates.sort((a, b) => a.title.localeCompare(b.title));
                  break;
              }

              const activeCategory = document.querySelector(
                ".category-item.active"
              ).dataset.category;
              renderTemplatesAdvanced(templates, activeCategory);
            });

          // Template actions
          document.addEventListener("click", (e) => {
            if (e.target.classList.contains("favorite-btn")) {
              const templateId = parseInt(e.target.dataset.templateId);
              const isFavorite = templateManager.favorites.includes(templateId);

              if (isFavorite) {
                templateManager.removeFromFavorites(templateId);
                e.target.innerHTML = "☆";
                e.target.style.color = "#ccc";
              } else {
                templateManager.addToFavorites(templateId);
                e.target.innerHTML = "⭐";
                e.target.style.color = "#f59e0b";
              }
            }

            if (
              e.target.classList.contains("template-card-advanced") ||
              e.target.closest(".template-card-advanced")
            ) {
              const card = e.target.closest(".template-card-advanced");
              const templateId = parseInt(card.dataset.templateId);
              const template = templateManager
                .getAllTemplates()
                .find((t) => t.id === templateId);

              if (template) {
                templateManager.updateTemplateStats(templateId, "used");
                document.getElementById("user-input").value = template.content;
                modal.remove();
                document.getElementById("user-input").focus();
                showToast(`ໃຊ້ແມ່ແບບ: ${template.title}`);
              }
            }
          });

          // Create template functionality
          document
            .getElementById("create-template-btn")
            .addEventListener("click", () => {
              showCreateTemplateModal();
            });

          // Import/Export functionality
          document
            .getElementById("export-templates-btn")
            .addEventListener("click", () => {
              templateManager.exportTemplates();
              showToast("ສົ່ງອອກແມ່ແບບສຳເລັດ!");
            });

          document
            .getElementById("import-templates-btn")
            .addEventListener("click", () => {
              const input = document.createElement("input");
              input.type = "file";
              input.accept = ".json";
              input.onchange = async (e) => {
                try {
                  await templateManager.importTemplates(e.target.files[0]);
                  renderTemplatesAdvanced(templateManager.getAllTemplates());
                  showToast("ນຳເຂົ້າແມ່ແບບສຳເລັດ!");
                } catch (error) {
                  showToast("ເກີດຂໍ້ຜິດພາດໃນການນຳເຂົ້າ!", "error");
                }
              };
              input.click();
            });

          // Close modal
          modal.querySelector(".close-btn").addEventListener("click", () => {
            modal.remove();
          });

          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        // Create Template Modal
        function showCreateTemplateModal() {
          const modal = document.createElement("div");
          modal.className = "modal";
          modal.style.display = "flex";

          modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px; width: 90%;">
              <span class="close-btn">&times;</span>
              <h2 style="margin-bottom: 20px; color: var(--text-color);">✨ ສ້າງແມ່ແບບໃໝ່</h2>
              
              <form id="create-template-form">
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">ຊື່ແມ່ແບບ:</label>
                  <input type="text" id="template-title" required 
                         style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                         placeholder="ໃສ່ຊື່ແມ່ແບບ...">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">ໝວດໝູ່:</label>
                  <select id="template-category" required 
                          style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                    <option value="">ເລືອກໝວດໝູ່...</option>
                    <option value="learning">📚 ການຮຽນຮູ້</option>
                    <option value="business">💼 ທຸລະກິດ</option>
                    <option value="creative">🎨 ສ້າງສັນ</option>
                    <option value="translation">🌐 ແປພາສາ</option>
                    <option value="coding">💻 ເຂົ້າລະຫັດ</option>
                    <option value="daily-life">🏠 ຊີວິດປະຈໍາວັນ</option>
                    <option value="health">🏥 ສຸຂະພາບ</option>
                    <option value="education">🎓 ການສຶກສາ</option>
                  </select>
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">ຄຳອະທິບາຍ:</label>
                  <textarea id="template-description" required rows="3"
                            style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; resize: vertical;"
                            placeholder="ອະທິບາຍວ່າແມ່ແບບນີ້ໃຊ້ເພື່ອຫຍັງ..."></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">ເນື້ອຫາແມ່ແບບ:</label>
                  <textarea id="template-content" required rows="6"
                            style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; resize: vertical;"
                            placeholder="ໃສ່ເນື້ອຫາແມ່ແບບທີ່ຕ້ອງການ..."></textarea>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                  <button type="button" class="cancel-btn" 
                          style="padding: 12px 24px; background: var(--secondary-color); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                    ຍົກເລີກ
                  </button>
                  <button type="submit" 
                          style="padding: 12px 24px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ສ້າງແມ່ແບບ
                  </button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(modal);

          // Form submission
          document
            .getElementById("create-template-form")
            .addEventListener("submit", (e) => {
              e.preventDefault();

              const template = {
                title: document.getElementById("template-title").value,
                category: document.getElementById("template-category").value,
                description: document.getElementById("template-description")
                  .value,
                content: document.getElementById("template-content").value,
                rating: 5.0,
              };

              templateManager.createUserTemplate(template);
              modal.remove();
              showToast("ສ້າງແມ່ແບບສຳເລັດ!");
            });

          // Close modal
          modal.querySelector(".close-btn").addEventListener("click", () => {
            modal.remove();
          });

          modal.querySelector(".cancel-btn").addEventListener("click", () => {
            modal.remove();
          });

          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        // Template Analytics Dashboard
        function showTemplateAnalytics() {
          const modal = document.createElement("div");
          modal.className = "modal";
          modal.style.display = "flex";

          const userTemplates = templateManager.userTemplates;
          const totalStats = userTemplates.reduce(
            (acc, template) => {
              const stats = templateManager.getTemplateStats(template.id);
              acc.totalViews += stats.views;
              acc.totalUses += stats.uses;
              acc.totalFavorites += stats.favorites;
              return acc;
            },
            { totalViews: 0, totalUses: 0, totalFavorites: 0 }
          );

          modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;">
              <span class="close-btn">&times;</span>
              <h2 style="margin-bottom: 20px; color: var(--text-color); display: flex; align-items: center; gap: 12px;">
                📊 ການວິເຄາະແມ່ແບບ - Template Analytics
              </h2>
              
              <!-- Overview Stats -->
              <div class="analytics-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px;">
                <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold;">${
                    userTemplates.length
                  }</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">ແມ່ແບບທັງໝົດ</div>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, var(--success-color), #16a34a); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold;">${
                    totalStats.totalUses
                  }</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">ການໃຊ້ງານ</div>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, var(--info-color), #2563eb); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold;">${
                    totalStats.totalViews
                  }</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">ການເບິ່ງ</div>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, var(--warning-color), #d97706); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold;">${
                    totalStats.totalFavorites
                  }</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">ລາຍການທີ່ຊອບ</div>
                </div>
              </div>

              <!-- Template Performance Table -->
              <div class="template-performance" style="background: var(--secondary-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px; color: var(--text-color);">🏆 ປະສິດທິພາບແມ່ແບບ</h3>
                
                <div class="performance-table" style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: var(--primary-color); color: white;">
                        <th style="padding: 12px; text-align: left; border-radius: 8px 0 0 8px;">ແມ່ແບບ</th>
                        <th style="padding: 12px; text-align: center;">ການເບິ່ງ</th>
                        <th style="padding: 12px; text-align: center;">ການໃຊ້</th>
                        <th style="padding: 12px; text-align: center;">ທີ໊ຊອບ</th>
                        <th style="padding: 12px; text-align: center; border-radius: 0 8px 8px 0;">ຄະແນນ</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${userTemplates
                        .map((template, index) => {
                          const stats = templateManager.getTemplateStats(
                            template.id
                          );
                          const score =
                            stats.uses * 3 + stats.favorites * 5 + stats.views;
                          return `
                          <tr style="border-bottom: 1px solid var(--border-color); ${
                            index % 2 === 0
                              ? "background: var(--background-color);"
                              : ""
                          }">
                            <td style="padding: 12px;">
                              <div style="font-weight: 600; color: var(--text-color);">${
                                template.title
                              }</div>
                              <div style="font-size: 0.8rem; color: var(--text-secondary);">${
                                template.category
                              }</div>
                            </td>
                            <td style="padding: 12px; text-align: center; color: var(--text-color);">${
                              stats.views
                            }</td>
                            <td style="padding: 12px; text-align: center; color: var(--text-color);">${
                              stats.uses
                            }</td>
                            <td style="padding: 12px; text-align: center; color: var(--text-color);">${
                              stats.favorites
                            }</td>
                            <td style="padding: 12px; text-align: center;">
                              <span style="background: ${
                                score > 50
                                  ? "var(--success-color)"
                                  : score > 20
                                  ? "var(--warning-color)"
                                  : "var(--error-color)"
                              }; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                ${score}
                              </span>
                            </td>
                          </tr>
                        `;
                        })
                        .join("")}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Category Distribution -->
              <div class="category-distribution" style="background: var(--secondary-color); border-radius: 12px; padding: 20px;">
                <h3 style="margin-bottom: 16px; color: var(--text-color); display: flex; align-items: center; gap: 8px;">
                  📈 ການແຈກຢາຍຕາມໝວດໝູ່
                </h3>
                
                <div class="category-chart" style="display: flex; flex-direction: column; gap: 12px;">
                  ${Object.entries(
                    userTemplates.reduce((acc, template) => {
                      acc[template.category] =
                        (acc[template.category] || 0) + 1;
                      return acc;
                    }, {})
                  )
                    .map(([category, count]) => {
                      const percentage = (count / userTemplates.length) * 100;
                      return `
                      <div class="category-bar" style="display: flex; align-items: center; gap: 12px;">
                        <div style="min-width: 120px; font-size: 0.9rem; color: var(--text-color);">
                          ${getCategoryName(category)}
                        </div>
                        <div style="flex: 1; background: var(--border-color); height: 20px; border-radius: 10px; overflow: hidden;">
                          <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--primary-hover)); border-radius: 10px; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="min-width: 60px; text-align: right; font-size: 0.9rem; color: var(--text-secondary);">
                          ${count} (${percentage.toFixed(1)}%)
                        </div>
                      </div>
                    `;
                    })
                    .join("")}
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // Close modal
          modal.querySelector(".close-btn").addEventListener("click", () => {
            modal.remove();
          });

          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        // Template Backup & Restore System
        function showBackupRestore() {
          const modal = document.createElement("div");
          modal.className = "modal";
          modal.style.display = "flex";

          modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px; width: 90%;">
              <span class="close-btn">&times;</span>
              <h2 style="margin-bottom: 20px; color: var(--text-color); display: flex; align-items: center; gap: 12px;">
                💾 ສຳຮອງ & ກູ້ຄືນ - Backup & Restore
              </h2>
              
              <!-- Backup Section -->
              <div class="backup-section" style="background: var(--secondary-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px; color: var(--text-color); display: flex; align-items: center; gap: 8px;">
                  📤 ສຳຮອງຂໍ້ມູນ
                </h3>
                
                <p style="color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5;">
                  ສຳຮອງແມ່ແບບ, ລາຍການທີ່ຊອບ, ແລະສະຖິຕິການໃຊ້ງານຂອງທ່ານ
                </p>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                  <button id="backup-all" style="padding: 12px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    💾 ສຳຮອງທັງໝົດ
                  </button>
                  
                  <button id="backup-templates-only" style="padding: 12px 20px; background: var(--info-color); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    📝 ແມ່ແບບເທົ່ານັ້ນ
                  </button>
                  
                  <button id="backup-favorites-only" style="padding: 12px 20px; background: var(--warning-color); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    ⭐ ລາຍການທີ່ຊອບ
                  </button>
                </div>
              </div>

              <!-- Restore Section -->
              <div class="restore-section" style="background: var(--secondary-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px; color: var(--text-color); display: flex; align-items: center; gap: 8px;">
                  📥 ກູ້ຄືນຂໍ້ມູນ
                </h3>
                
                <p style="color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5;">
                  ກູ້ຄືນຂໍ້ມູນຈາກໄຟລ์ສຳຮອງ (.json)
                </p>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                  <button id="restore-data" style="padding: 12px 20px; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    📥 ກູ້ຄືນຂໍ້ມູນ
                  </button>
                  
                  <button id="reset-all" style="padding: 12px 20px; background: var(--error-color); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    🗑️ ລຶບທັງໝົດ
                  </button>
                </div>
              </div>

              <!-- Auto Backup Settings -->
              <div class="auto-backup-section" style="background: var(--secondary-color); border-radius: 12px; padding: 20px;">
                <h3 style="margin-bottom: 16px; color: var(--text-color); display: flex; align-items: center; gap: 8px;">
                  ⚙️ ການຕັ້ງຄ່າສຳຮອງອັດຕະໂນມັດ
                </h3>
                
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" id="auto-backup-enabled" style="width: 18px; height: 18px;">
                  <label for="auto-backup-enabled" style="color: var(--text-color); cursor: pointer;">
                    ເປີດໃຊ້ການສຳຮອງອັດຕະໂນມັດ
                  </label>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px;">
                  <label style="color: var(--text-color);">ສຳຮອງທຸກໆ:</label>
                  <select id="backup-interval" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--background-color); color: var(--text-color);">
                    <option value="daily">ທຸກມື້</option>
                    <option value="weekly">ທຸກອາທິດ</option>
                    <option value="monthly">ທຸກເດືອນ</option>
                  </select>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // Backup functionality
          document
            .getElementById("backup-all")
            .addEventListener("click", () => {
              const backupData = {
                userTemplates: templateManager.userTemplates,
                favorites: templateManager.favorites,
                stats: templateManager.templateStats,
                chatHistories: chatHistories,
                settings: { theme: currentTheme },
                backupDate: new Date().toISOString(),
                version: "1.0",
              };

              downloadBackup(backupData, "complete-backup");
              showToast("ສຳຮອງຂໍ້ມູນທັງໝົດສຳເລັດ!");
            });

          document
            .getElementById("backup-templates-only")
            .addEventListener("click", () => {
              const backupData = {
                userTemplates: templateManager.userTemplates,
                backupDate: new Date().toISOString(),
                type: "templates-only",
              };

              downloadBackup(backupData, "templates-backup");
              showToast("ສຳຮອງແມ່ແບບສຳເລັດ!");
            });

          document
            .getElementById("backup-favorites-only")
            .addEventListener("click", () => {
              const backupData = {
                favorites: templateManager.favorites,
                backupDate: new Date().toISOString(),
                type: "favorites-only",
              };

              downloadBackup(backupData, "favorites-backup");
              showToast("ສຳຮອງລາຍການທີ່ຊອບສຳເລັດ!");
            });

          // Restore functionality
          document
            .getElementById("restore-data")
            .addEventListener("click", () => {
              const input = document.createElement("input");
              input.type = "file";
              input.accept = ".json";
              input.onchange = async (e) => {
                try {
                  const file = e.target.files[0];
                  const reader = new FileReader();
                  reader.onload = (e) => {
                    try {
                      const data = JSON.parse(e.target.result);
                      restoreData(data);
                      modal.remove();
                      showToast("ກູ້ຄືນຂໍ້ມູນສຳເລັດ!");
                    } catch (error) {
                      showToast("ໄຟລ์ບໍ່ຖືກຕ້ອງ!", "error");
                    }
                  };
                  reader.readAsText(file);
                } catch (error) {
                  showToast("ເກີດຂໍ້ຜິດພາດໃນການກູ້ຄືນ!", "error");
                }
              };
              input.click();
            });

          document.getElementById("reset-all").addEventListener("click", () => {
            if (
              confirm(
                "ທ່ານແນ່ໃຈບໍ່ວ່າຕ້ອງການລຶບຂໍ້ມູນທັງໝົດ? ການກະທຳນີ້ບໍ່ສາມາດຍົກເລີກໄດ້!"
              )
            ) {
              localStorage.removeItem("userTemplates");
              localStorage.removeItem("favoriteTemplates");
              localStorage.removeItem("templateStats");
              localStorage.removeItem("chatHistories");

              templateManager.userTemplates = [];
              templateManager.favorites = [];
              templateManager.templateStats = {};

              modal.remove();
              showToast("ລຶບຂໍ້ມູນທັງໝົດສຳເລັດ!");
            }
          });

          function downloadBackup(data, type) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `lao-chat-${type}-${
              new Date().toISOString().split("T")[0]
            }.json`;
            a.click();
            URL.revokeObjectURL(url);
          }

          function restoreData(data) {
            if (data.userTemplates) {
              templateManager.userTemplates = data.userTemplates;
              templateManager.saveUserTemplates();
            }

            if (data.favorites) {
              templateManager.favorites = data.favorites;
              templateManager.saveFavorites();
            }

            if (data.stats) {
              templateManager.templateStats = data.stats;
              localStorage.setItem("templateStats", JSON.stringify(data.stats));
            }

            if (data.chatHistories) {
              Object.assign(chatHistories, data.chatHistories);
              saveChatHistories();
            }

            if (data.settings && data.settings.theme) {
              setTheme(data.settings.theme);
            }
          }

          // Close modal
          modal.querySelector(".close-btn").addEventListener("click", () => {
            modal.remove();
          });

          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }



        // Check for shared template in URL
        function checkForSharedTemplate() {
          const urlParams = new URLSearchParams(window.location.search);
          const templateData = urlParams.get("template");

          if (templateData) {
            try {
              const template = JSON.parse(atob(templateData));

              if (confirm(`ທ່ານຕ້ອງການນຳເຂົ້າແມ່ແບບ "${template.title}" ບໍ?`)) {
                templateManager.createUserTemplate(template);
                showToast(`ນຳເຂົ້າແມ່ແບບ "${template.title}" ສຳເລັດ!`);

                // Clear URL parameter
                window.history.replaceState(
                  {},
                  document.title,
                  window.location.pathname
                );
              }
            } catch (error) {
              console.error("Invalid template data in URL");
            }
          }
        }

        // Enhanced Toast System
        function showToast(message, type = "success", duration = 3000) {
          const toast = document.createElement("div");
          toast.className = "toast";

          const icons = {
            success: "✅",
            error: "❌",
            warning: "⚠️",
            info: "ℹ️",
          };

          const colors = {
            success: "var(--success-color)",
            error: "var(--error-color)",
            warning: "var(--warning-color)",
            info: "var(--info-color)",
          };

          toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type]};
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            max-width: 400px;
            animation: toastSlideIn 0.3s ease;
            backdrop-filter: blur(10px);
          `;

          toast.innerHTML = `
            <span style="font-size: 1.2rem;">${icons[type]}</span>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; margin-left: auto;">×</button>
          `;

          document.body.appendChild(toast);

          setTimeout(() => {
            toast.style.animation = "slideOut 0.3s ease";
            setTimeout(() => toast.remove(), 300);
          }, duration);
        }

        // Add toast animations to CSS
        const toastStyles = document.createElement("style");
        toastStyles.textContent = `
          @keyframes toastSlideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }

          @keyframes toastSlideOut {
            from {
              transform: translateX(0);
              opacity: 1;
            }
            to {
              transform: translateX(100%);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(toastStyles);



        // Check for shared template on load
        checkForSharedTemplate();

        // Initialize everything
        initializeLaoLanguage();
        setTheme(currentTheme);
        updateConnectionStatus("online");
        loadChatHistories();

        // Initialize virtual scrolling if chat history is large
        if (Object.keys(chatHistories).length > 50) {
          virtualList = new VirtualChatList(chatContainer);
        }
      });
    </script>
  </body>
</html>
